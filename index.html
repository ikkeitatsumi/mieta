<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>mieta — つながりを、透明に。</title>
<meta name="description" content="Instagramのフォロー関係をブラウザだけで解析。データはどこにも送信されません。">
<!-- OGP -->
<meta property="og:title" content="mieta — つながりを、透明に。">
<meta property="og:description" content="Instagramのフォロー関係を、あなたのブラウザだけで解析。フォロバされていない人が一目でわかる。">
<meta property="og:type" content="website">
<meta property="og:locale" content="ja_JP">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mieta">
<meta name="twitter:description" content="つながりを、透明に。Instagramフォロー関係解析ツール。">
<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%231D1D1F'/><text x='50' y='68' font-family='system-ui' font-size='42' font-weight='600' fill='white' text-anchor='middle'>m</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%231D1D1F'/><text x='50' y='68' font-family='system-ui' font-size='42' font-weight='600' fill='white' text-anchor='middle'>m</text></svg>">
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* ═══════════════════════════════════════════════════════════
   mieta — Unified Design System
   The Reflection Lens + Full Service App
   ═══════════════════════════════════════════════════════════ */

:root {
  --white: #FFFFFF;
  --off-white: #F5F5F7;
  --jet: #1D1D1F;
  --sub: #86868B;
  --accent: #0071E3;
  --border: rgba(0,0,0,0.06);
  --border-light: rgba(255,255,255,0.5);
  --glass: rgba(255,255,255,0.55);
  --glass-strong: rgba(255,255,255,0.72);
  --red: #FF3B30;
  --orange: #FF9500;
  --green: #34C759;
  --purple: #5856D6;
  --radius-sm: 12px;
  --radius-md: 20px;
  --radius-lg: 28px;
  --shadow-sm: 0 2px 12px rgba(0,0,0,0.04);
  --shadow-md: 0 8px 32px rgba(0,0,0,0.06);
  --shadow-lg: 0 16px 56px -12px rgba(0,0,0,0.1);
  --ease-out: cubic-bezier(.16,1,.3,1);
  --ease-smooth: cubic-bezier(.4,0,.2,1);
  --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
}

*,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-family: var(--font); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; scroll-behavior: smooth; }
body { overflow-x: hidden; position: relative; background: #000; color: var(--jet); }
::selection { background: rgba(0,113,227,0.15); }
input::placeholder { color: var(--sub); }
button { font-family: inherit; }

/* ═══ PHASE 1: DARK HERO (Lens Animation) ═══ */

#hero-section {
  position: relative; width: 100%; height: 100vh; height: 100dvh;
  overflow: hidden; background: #000;
  transition: opacity 0.8s ease, transform 0.8s ease;
}
#hero-section.hidden {
  opacity: 0; transform: scale(0.98);
  pointer-events: none; position: absolute;
}

#lens-canvas {
  display: block; position: absolute; inset: 0; z-index: 1;
}

/* Hero overlay text */
.hero-overlay {
  position: absolute; inset: 0; z-index: 10;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  pointer-events: none;
}
/* Ensure all interactive children are tappable on mobile */
.hero-overlay button, .hero-overlay a, .hero-overlay [onclick] {
  pointer-events: auto !important;
  -webkit-tap-highlight-color: rgba(255,255,255,0.1);
  touch-action: manipulation;
}
.hero-logo {
  position: absolute; top: max(20px, env(safe-area-inset-top)); left: max(24px, env(safe-area-inset-left));
  display: flex; flex-direction: column; align-items: center; gap: 12px;
  opacity: 0; animation: heroFadeIn 1s ease 0.3s forwards;
}
.hero-logo svg {
  width: 80px;
  height: 80px;
}
.hero-logo-text {
  font-size: 12px; font-weight: 600; letter-spacing: -0.03em;
  color: rgba(255,255,255,0.3);
  opacity: 0; animation: logoTextReveal 1s ease 1.5s forwards;
}
.nav-logo-svg {
  width: 24px;
  height: 24px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.hero-pro-btn {
  position: absolute; top: max(18px, env(safe-area-inset-top)); right: max(24px, env(safe-area-inset-right));
  font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.35);
  padding: 5px 14px; border-radius: 100px;
  border: 1.5px solid rgba(255,255,255,0.15); background: none;
  cursor: pointer; letter-spacing: 0.04em; pointer-events: auto;
  opacity: 0; animation: heroFadeIn 1s ease 0.5s forwards;
  transition: all 0.3s ease;
}
.hero-pro-btn:hover { border-color: rgba(255,255,255,0.4); color: rgba(255,255,255,0.6); }

/* ═══ HERO CENTER LOGO ANIMATION ═══ */
.hero-center-logo {
  display: flex; flex-direction: column; align-items: center;
  margin-top: clamp(40px, 8vh, 100px);
}
.hero-center-logo svg.logo-svg {
  overflow: visible;
  filter: drop-shadow(0 0 40px rgba(255,255,255,0.03));
}
/* Orbit draw */
@keyframes hOrbitDraw {
  0% { stroke-dashoffset: 427.26; opacity: 0; }
  5% { opacity: 1; }
  100% { stroke-dashoffset: 0; opacity: 1; }
}
/* Dot slide in */
@keyframes hDotSlide {
  0% { opacity: 0; transform: translate(-24px,-16px) scale(0); }
  30% { opacity: 1; }
  100% { opacity: 1; transform: translate(0,0) scale(1); }
}
/* Iris bounce */
@keyframes hIrisScale {
  0% { transform: scale(0); opacity: 0; }
  60% { transform: scale(1.06); }
  80% { transform: scale(0.98); }
  100% { transform: scale(1); opacity: 1; }
}
@keyframes hIrisScale2 {
  0% { transform: scale(0); opacity: 0; }
  50% { transform: scale(1.08); }
  75% { transform: scale(0.97); }
  100% { transform: scale(1); opacity: 1; }
}
/* Light sweep */
@keyframes hLightSweep {
  0% { opacity: 0; transform: rotate(-30deg); }
  20% { opacity: 0.5; }
  100% { opacity: 0; transform: rotate(330deg); }
}
/* Center dot */
@keyframes hCenterDot {
  0% { transform: scale(0); opacity: 0; }
  60% { transform: scale(1.1); }
  100% { transform: scale(1); opacity: 1; }
}
/* Connecting lines */
@keyframes hLineFade {
  0% { opacity: 0; }
  100% { opacity: 1; }
}
/* Logo text: "mieta" */
@keyframes hTextReveal {
  0% { opacity: 0; transform: translateY(14px); letter-spacing: 0.35em; }
  100% { opacity: 1; transform: translateY(0); letter-spacing: 0.14em; }
}
/* Subtitle: "The Reflection of Connection" */
@keyframes hSubReveal {
  0% { opacity: 0; transform: translateY(10px); }
  100% { opacity: 1; transform: translateY(0); }
}
/* Pulse glow (after complete) */
@keyframes hPulseGlow {
  0%, 100% { filter: drop-shadow(0 0 0px transparent); }
  50% { filter: drop-shadow(0 0 8px rgba(255,255,255,0.08)); }
}

.hero-logo-type {
  font-size: clamp(28px, 5.5vw, 40px); font-weight: 600;
  color: rgba(255,255,255,0.9); letter-spacing: 0.14em;
  text-align: center; margin-top: 8px;
  opacity: 0; animation: hTextReveal 1.0s var(--ease-out) 1.5s forwards;
}
.hero-logo-sub {
  font-size: clamp(9px, 1.4vw, 12px); font-weight: 400;
  letter-spacing: 0.18em; text-transform: uppercase;
  color: rgba(255,255,255,0.25); text-align: center;
  margin-top: 10px;
  opacity: 0; animation: hSubReveal 0.8s var(--ease-out) 1.9s forwards;
}

/* CTA on hero */
.hero-cta {
  margin-top: 36px; pointer-events: auto;
  opacity: 0; animation: heroFadeUp 1s var(--ease-out) 2.3s forwards;
}
.hero-cta-btn {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 14px 32px; border-radius: 100px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  color: rgba(255,255,255,0.8); font-size: 15px; font-weight: 400;
  cursor: pointer; letter-spacing: 0.02em;
  transition: all 0.4s ease;
  /* Mobile touch */
  -webkit-tap-highlight-color: rgba(255,255,255,0.1);
  touch-action: manipulation;
  position: relative; z-index: 20;
}
.hero-cta-btn:hover {
  background: rgba(255,255,255,0.14);
  border-color: rgba(255,255,255,0.2);
  color: #fff; transform: translateY(-1px);
}
.hero-cta-btn svg { transition: transform 0.3s ease; }
.hero-cta-btn:hover svg { transform: translateX(3px); }

/* Scroll hint */
.hero-scroll-hint {
  position: absolute; bottom: clamp(24px, 4vh, 40px); left: 50%;
  transform: translateX(-50%);
  opacity: 0; animation: heroFadeIn 1.5s ease 2.5s forwards;
}

/* Hero keyframes */
@keyframes heroFadeIn { from { opacity:0 } to { opacity:1 } }
@keyframes heroFadeUp { from { opacity:0; transform:translateY(16px) } to { opacity:1; transform:translateY(0) } }

/* ═══ PHASE 2: LIGHT APP SCREENS ═══ */

#app-section {
  position: relative; z-index: 20;
  background: var(--white);
  min-height: 100vh; min-height: 100dvh;
  display: none;
  transition: opacity 0.6s ease;
}
#app-section.active { display: block; }

/* Background blobs for light screens */
#bg-blobs {
  position: fixed; inset: 0; z-index: 0;
  pointer-events: none;
  transition: filter 1.2s var(--ease-smooth);
}
#bg-blobs.active { filter: blur(4px) brightness(1.06); }
.blob {
  position: absolute; border-radius: 50%;
  filter: blur(100px); will-change: transform;
  animation: blobDrift var(--dur) ease-in-out var(--delay) infinite alternate;
}
@keyframes blobDrift {
  0%   { transform: translate(0,0) scale(1); }
  33%  { transform: translate(var(--tx1), var(--ty1)) scale(var(--s1)); }
  66%  { transform: translate(var(--tx2), var(--ty2)) scale(var(--s2)); }
  100% { transform: translate(var(--tx3), var(--ty3)) scale(var(--s3)); }
}
#noise-overlay {
  position: fixed; inset: 0; z-index: 1;
  pointer-events: none; opacity: 0.4;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.02'/%3E%3C/svg%3E");
  display: none;
}
#noise-overlay.active { display: block; }

/* ═══ NAVBAR (Light Mode) ═══ */
#navbar {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  height: 52px; display: none; align-items: center;
  padding: 0 max(20px, env(safe-area-inset-left));
  transition: all 0.5s var(--ease-smooth);
  background: rgba(255,255,255,0.01);
  border-bottom: 0.5px solid transparent;
}
#navbar.active { display: flex; }
#navbar.scrolled {
  background: var(--glass-strong);
  backdrop-filter: blur(24px) saturate(180%);
  -webkit-backdrop-filter: blur(24px) saturate(180%);
  border-bottom-color: var(--border);
}
.nav-inner {
  max-width: 1080px; width: 100%; margin: 0 auto; padding: 0 12px;
  display: flex; align-items: center; justify-content: space-between;
}
.nav-logo {
  font-size: 20px; font-weight: 600; letter-spacing: -0.03em;
  color: var(--jet); background: none; border: none; cursor: pointer; padding: 0;
}
.nav-right { display: flex; align-items: center; gap: 16px; }
.nav-link {
  font-size: 13px; color: var(--sub); background: none; border: none;
  cursor: pointer; padding: 4px 0; letter-spacing: 0.01em; transition: color 0.2s;
}
.nav-link:hover { color: var(--jet); }
.nav-pro {
  font-size: 12px; font-weight: 600; color: var(--accent);
  padding: 5px 14px; border-radius: 100px;
  border: 1.5px solid var(--accent); background: none;
  cursor: pointer; letter-spacing: 0.04em; transition: all 0.3s ease;
}
.nav-pro:hover { background: var(--accent); color: #fff; }
.nav-user-info {
  display: flex; align-items: center; gap: 12px;
  font-size: 13px; color: var(--jet);
}
.nav-user-email {
  max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.nav-logout-btn {
  font-size: 12px; color: var(--sub); background: none; border: none;
  cursor: pointer; transition: color 0.2s;
}
.nav-logout-btn:hover { color: var(--jet); }

/* ═══ SCREEN SYSTEM ═══ */
.screen {
  display: none; min-height: 100vh; min-height: 100dvh;
  position: relative; z-index: 2;
  opacity: 0; transform: translateY(16px);
  transition: opacity 0.6s var(--ease-out), transform 0.6s var(--ease-out);
}
.screen.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }
.screen.visible { opacity: 1; transform: translateY(0); }

/* ═══ SCREEN: GUIDE ═══ */
#screen-guide { padding: 100px 24px 60px; min-height: 100vh; justify-content: flex-start; }
.guide-header { text-align: center; margin-bottom: 48px; padding-top: 40px; }
.guide-header h1 {
  font-size: clamp(36px, 8vw, 56px); font-weight: 700;
  letter-spacing: -0.04em; line-height: 1.08;
  background: linear-gradient(180deg, var(--jet) 0%, var(--jet) 50%, rgba(29,29,31,0.35) 85%, rgba(0,113,227,0.2) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.guide-header p { font-size: 17px; font-weight: 300; color: var(--sub); margin-top: 16px; line-height: 1.7; }

.guide-card {
  width: 100%; max-width: 560px;
  background: var(--glass);
  backdrop-filter: blur(24px) saturate(160%);
  -webkit-backdrop-filter: blur(24px) saturate(160%);
  border-radius: var(--radius-lg);
  border: 0.5px solid var(--border-light);
  box-shadow: var(--shadow-md); overflow: hidden;
}
.guide-deeplink {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 16px 24px;
  background: linear-gradient(135deg, var(--accent), var(--purple));
  color: #fff; text-decoration: none; font-size: 15px; font-weight: 500;
  transition: opacity 0.2s;
}
.guide-deeplink:hover { opacity: 0.9; }
.guide-deeplink svg { flex-shrink: 0; }
.guide-steps { padding: 8px 0; }
.guide-step {
  display: flex; gap: 16px; padding: 18px 24px;
  border-bottom: 0.5px solid var(--border); align-items: flex-start;
}
.guide-step:last-child { border-bottom: none; }
.step-num {
  width: 28px; height: 28px; border-radius: 50%; background: var(--off-white);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 600; color: var(--jet); flex-shrink: 0;
}
.step-text { font-size: 14px; color: var(--jet); line-height: 1.6; padding-top: 3px; }
.step-text small { display: block; font-size: 12px; color: var(--sub); margin-top: 2px; }
.guide-next {
  width: 100%; max-width: 560px; margin-top: 24px; padding: 16px;
  border-radius: var(--radius-md); background: var(--jet); color: #fff;
  border: none; font-size: 16px; font-weight: 500; cursor: pointer;
  transition: all 0.3s ease;
}
.guide-next:hover { background: #333; transform: translateY(-1px); }

/* ═══ SCREEN: UPLOAD ═══ */
#screen-upload { padding: 100px 24px 60px; }
.upload-header { text-align: center; margin-bottom: 48px; }
.upload-header h2 { font-size: clamp(28px, 6vw, 40px); font-weight: 600; letter-spacing: -0.03em; color: var(--jet); }
.upload-header p { font-size: 15px; color: var(--sub); margin-top: 10px; }

.upload-zone {
  position: relative; width: 100%; max-width: 520px;
  padding: 52px 40px; border-radius: var(--radius-lg);
  cursor: pointer; overflow: hidden; text-align: center;
  background: var(--glass);
  backdrop-filter: blur(24px) saturate(160%);
  -webkit-backdrop-filter: blur(24px) saturate(160%);
  border: 2px dashed rgba(0,0,0,0.08);
  box-shadow: inset 0 0 0 1px var(--border-light), var(--shadow-sm);
  transition: all 0.5s var(--ease-smooth);
}
.upload-zone::before {
  content: ''; position: absolute; top: 0; left: 10%; right: 10%; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
  opacity: 0.5; transition: opacity 0.4s;
}
.upload-zone:hover {
  background: rgba(255,255,255,0.65);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.7), var(--shadow-md);
  border-color: rgba(0,0,0,0.05);
}
.upload-zone.dragging {
  background: rgba(255,255,255,0.35);
  backdrop-filter: blur(40px) saturate(200%);
  -webkit-backdrop-filter: blur(40px) saturate(200%);
  border-color: rgba(0,113,227,0.3);
  box-shadow: inset 0 0 0 1.5px rgba(0,113,227,0.25), 0 24px 80px -12px rgba(0,113,227,0.12);
  transform: scale(1.01);
}
.upload-zone.dragging::before { opacity: 1; }
.upload-zone.dragging .upload-icon-wrap { animation: gentleFloat 2.5s ease-in-out infinite; }
.upload-zone.dragging .upload-icon-wrap svg { stroke: var(--accent); }
.upload-icon-wrap {
  width: 52px; height: 52px; border-radius: 16px;
  display: inline-flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.03); margin-bottom: 18px; transition: background 0.4s;
}
.upload-zone.dragging .upload-icon-wrap { background: rgba(0,113,227,0.08); }
.upload-title { font-size: 17px; font-weight: 400; color: var(--jet); transition: color 0.3s; }
.upload-zone.dragging .upload-title { color: var(--accent); }
.upload-sub { font-size: 13px; color: var(--sub); margin-top: 6px; }
.upload-formats {
  display: inline-block; margin-top: 18px; font-size: 11px; color: var(--sub);
  padding: 4px 14px; border-radius: 100px; background: rgba(0,0,0,0.02);
}
#file-input { display: none; }

/* OS Guide */
.os-guide { width: 100%; max-width: 520px; margin-top: 28px; }
.os-tabs { display: flex; background: var(--off-white); border-radius: var(--radius-sm); padding: 3px; margin-bottom: 16px; }
.os-tab {
  flex: 1; padding: 10px 0; font-size: 14px; font-weight: 500;
  border: none; background: transparent; cursor: pointer;
  border-radius: 10px; color: var(--sub); transition: all 0.25s ease;
}
.os-tab.active { background: #fff; color: var(--jet); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
.os-hint { font-size: 13px; color: var(--sub); line-height: 1.7; padding: 16px 20px; border-radius: var(--radius-sm); background: var(--off-white); }
.os-hint strong { color: var(--jet); font-weight: 500; }
.security-badge {
  display: inline-flex; align-items: center; gap: 8px;
  margin-top: 28px; padding: 8px 18px; border-radius: 100px;
  background: rgba(255,255,255,0.5); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  border: 0.5px solid rgba(255,255,255,0.6);
}
.security-badge svg { flex-shrink: 0; }
.security-badge span { font-size: 12px; color: var(--sub); }
.back-link {
  display: inline-flex; align-items: center; gap: 6px;
  margin-bottom: 32px; padding: 0; background: none; border: none;
  cursor: pointer; font-size: 14px; color: var(--accent);
}
.back-link:hover { text-decoration: underline; }
.error-msg {
  width: 100%; max-width: 520px; margin-top: 16px; padding: 16px 20px;
  border-radius: var(--radius-sm); background: rgba(255,59,48,0.06);
  font-size: 14px; color: var(--red); line-height: 1.6; display: none;
}
.error-msg.show { display: block; animation: fadeSlide 0.4s var(--ease-out); }

/* ═══ SCREEN: RESULTS ═══ */
#screen-results { padding: 100px 24px 60px; justify-content: flex-start; align-items: stretch; }
.results-inner { max-width: 720px; width: 100%; margin: 0 auto; }
.results-header { text-align: center; margin-bottom: 40px; padding-top: 32px; }
.results-header h2 { font-size: clamp(28px, 5vw, 42px); font-weight: 600; letter-spacing: -0.03em; color: var(--jet); }
.results-header p { font-size: 15px; color: var(--sub); margin-top: 8px; }
.results-actions { display: flex; gap: 12px; justify-content: center; margin-top: 16px; flex-wrap: wrap; }
.results-history-btn {
  font-size: 13px; color: var(--sub); background: none; border: none;
  cursor: pointer; padding: 4px 0; transition: color 0.2s;
}
.results-history-btn:hover { color: var(--jet); }

/* Stats Grid */
.stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 36px; }
@media (min-width: 600px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }
.stat-card {
  position: relative; padding: 24px 20px; border-radius: var(--radius-md); overflow: hidden;
  background: var(--off-white); transition: all 0.4s var(--ease-smooth); cursor: pointer;
}
.stat-card:hover { background: var(--white); box-shadow: var(--shadow-lg); transform: translateY(-2px); }
.stat-label { font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.1em; color: var(--sub); }
.stat-value { font-size: clamp(32px, 5vw, 44px); font-weight: 300; letter-spacing: -0.03em; color: var(--jet); margin-top: 8px; line-height: 1; }
.stat-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 2px; opacity: 0.5; }

/* Tabs */
.result-tabs { display: flex; background: var(--off-white); border-radius: var(--radius-sm); padding: 3px; margin-bottom: 20px; }
.result-tab {
  flex: 1; padding: 10px 6px; border: none; background: transparent;
  cursor: pointer; font-size: 13px; font-weight: 500;
  color: var(--sub); border-radius: 10px; transition: all 0.25s ease; white-space: nowrap;
}
.result-tab.active { background: #fff; color: var(--jet); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
.tab-count {
  display: inline-block; margin-left: 4px; font-size: 11px; font-weight: 600;
  padding: 1px 6px; border-radius: 100px; background: rgba(0,0,0,0.05); color: var(--sub);
}
.result-tab.active .tab-count { background: rgba(0,113,227,0.1); color: var(--accent); }

/* Toolbar */
.list-toolbar { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
.search-wrap { flex: 1; min-width: 160px; position: relative; }
.search-wrap svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; }
.search-input {
  width: 100%; padding: 10px 16px 10px 36px; font-size: 14px;
  border: 1px solid rgba(0,0,0,0.06); border-radius: var(--radius-sm);
  background: var(--off-white); color: var(--jet); outline: none; font-family: inherit;
  transition: border-color 0.2s, background 0.2s;
}
.search-input:focus { border-color: var(--accent); background: #fff; }
.sort-btn, .copy-btn, .share-btn {
  padding: 9px 14px; border-radius: var(--radius-sm);
  border: 1px solid rgba(0,0,0,0.06); background: var(--off-white); cursor: pointer;
  font-size: 12px; font-weight: 500; color: var(--sub);
  display: inline-flex; align-items: center; gap: 5px; transition: all 0.2s; white-space: nowrap;
}
.sort-btn:hover, .copy-btn:hover, .share-btn:hover { background: #fff; border-color: rgba(0,0,0,0.1); color: var(--jet); }

/* User List */
.user-list { padding: 0; }
.user-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 0; border-bottom: 0.5px solid var(--border);
  animation: fadeSlide 0.3s var(--ease-out) both;
}
.user-row:last-child { border-bottom: none; }
.user-info { display: flex; align-items: center; gap: 12px; min-width: 0; flex: 1; }
.user-avatar {
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-size: 14px; font-weight: 500; flex-shrink: 0;
}
.user-name-wrap { min-width: 0; }
.user-name {
  font-size: 15px; color: var(--jet); text-decoration: none;
  display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; transition: color 0.2s;
}
a.user-name:hover { color: var(--accent); }
.user-date { font-size: 12px; color: var(--sub); margin-top: 1px; }
.user-actions { display: flex; gap: 2px; opacity: 0; transition: opacity 0.2s; }
.user-row:hover .user-actions { opacity: 1; }
.user-action-btn { background: none; border: none; cursor: pointer; padding: 6px; border-radius: 8px; display: flex; transition: background 0.2s; }
.user-action-btn:hover { background: rgba(0,0,0,0.04); }
.user-row.locked .user-name { filter: blur(8px); pointer-events: none; }
.user-row.locked .user-date { filter: blur(6px); }
.user-row.locked .user-actions { display: none; }

/* Premium Banner */
.premium-banner {
  display: none; margin-top: 12px; padding: 28px 24px; border-radius: var(--radius-md);
  background: linear-gradient(135deg, rgba(0,113,227,0.04), rgba(88,86,214,0.04));
  border: 1px solid rgba(0,113,227,0.1); text-align: center;
}
.premium-banner.show { display: block; animation: fadeSlide 0.5s var(--ease-out); }
.premium-banner h4 { font-size: 17px; font-weight: 600; color: var(--jet); }
.premium-banner p { font-size: 13px; color: var(--sub); margin-top: 6px; line-height: 1.6; }
.premium-buy {
  display: inline-flex; align-items: center; gap: 6px;
  margin-top: 16px; padding: 12px 28px; border-radius: 14px;
  background: linear-gradient(135deg, var(--accent), var(--purple));
  color: #fff; border: none; cursor: pointer; font-size: 15px; font-weight: 500;
  transition: opacity 0.2s, transform 0.2s;
}
.premium-buy:hover { opacity: 0.9; transform: translateY(-1px); }
.premium-price { font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 8px; }

/* ═══ OVERLAYS ═══ */

/* Analyzing */
#analyzing-overlay {
  display: none; position: fixed; inset: 0; z-index: 300;
  align-items: center; justify-content: center; flex-direction: column;
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%);
}
#analyzing-overlay.show { display: flex; animation: fadeIn 0.5s ease; }
.analyzing-bar { position: absolute; top: 0; left: 0; right: 0; height: 2px; background: rgba(0,0,0,0.04); }
.analyzing-bar-fill { height: 100%; width: 0; background: linear-gradient(90deg, var(--accent), var(--purple)); transition: width 0.5s var(--ease-smooth); }
.analyzing-status { font-size: 14px; color: var(--sub); letter-spacing: 0.03em; animation: subtlePulse 2.5s ease-in-out infinite; }
.analyzing-pct { font-size: 56px; font-weight: 200; color: var(--jet); letter-spacing: -0.04em; margin-top: 10px; }
.analyzing-pct span { font-size: 24px; font-weight: 300; color: var(--sub); }

/* Auth Modal */
#auth-modal { display: none; position: fixed; inset: 0; z-index: 400; align-items: center; justify-content: center; }
#auth-modal.show { display: flex; animation: fadeIn 0.3s ease; }
.auth-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); cursor: pointer; }
.auth-card {
  position: relative; z-index: 1;
  background: rgba(255,255,255,0.92); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
  border-radius: 24px; padding: 48px 40px; max-width: 400px; width: 90%;
  box-shadow: 0 24px 80px rgba(0,0,0,0.12); text-align: center;
}
.auth-close { position: absolute; top: 16px; right: 16px; background: none; border: none; cursor: pointer; padding: 4px; color: var(--sub); }
.auth-card h3 { font-size: 24px; font-weight: 600; color: var(--jet); margin-bottom: 12px; }
.auth-card p { font-size: 14px; color: var(--sub); margin-bottom: 24px; line-height: 1.6; }
.auth-toggle { display: flex; background: var(--off-white); border-radius: var(--radius-sm); padding: 3px; margin-bottom: 24px; }
.auth-toggle-btn {
  flex: 1; padding: 10px; border: none; background: transparent;
  cursor: pointer; font-size: 13px; font-weight: 500;
  color: var(--sub); border-radius: 9px; transition: all 0.25s ease;
}
.auth-toggle-btn.active { background: #fff; color: var(--jet); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
.auth-form {
  display: flex; flex-direction: column; gap: 12px; text-align: left;
}
.auth-input {
  padding: 12px 16px; font-size: 14px;
  border: 1px solid rgba(0,0,0,0.06); border-radius: var(--radius-sm);
  background: var(--off-white); color: var(--jet); outline: none; font-family: inherit;
  transition: border-color 0.2s, background 0.2s;
}
.auth-input:focus { border-color: var(--accent); background: #fff; }
.auth-error { font-size: 13px; color: var(--red); margin-top: 8px; display: none; }
.auth-error.show { display: block; }
.auth-submit {
  width: 100%; padding: 12px 0; margin-top: 8px;
  background: linear-gradient(135deg, var(--accent), var(--purple));
  color: #fff; border: none; border-radius: 12px;
  font-size: 15px; font-weight: 500; cursor: pointer; transition: opacity 0.2s;
}
.auth-submit:hover { opacity: 0.9; }
.auth-submit:disabled { opacity: 0.5; cursor: not-allowed; }

/* Unlock Modal */
#unlock-modal { display: none; position: fixed; inset: 0; z-index: 400; align-items: center; justify-content: center; }
#unlock-modal.show { display: flex; animation: fadeIn 0.3s ease; }
.unlock-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
.unlock-card {
  position: relative; z-index: 1;
  background: rgba(255,255,255,0.92); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
  border-radius: 24px; padding: 48px 40px; max-width: 400px; width: 90%;
  box-shadow: 0 24px 80px rgba(0,0,0,0.12); text-align: center;
}
.unlock-close { position: absolute; top: 16px; right: 16px; background: none; border: none; cursor: pointer; padding: 4px; color: var(--sub); }
.unlock-badge { display: inline-block; padding: 6px 14px; border-radius: 100px; background: linear-gradient(135deg, var(--accent), var(--purple)); color: #fff; font-size: 13px; font-weight: 600; }
.unlock-card h3 { font-size: 24px; font-weight: 600; margin-top: 20px; color: var(--jet); }
.unlock-card > p { font-size: 14px; color: var(--sub); margin-top: 8px; line-height: 1.6; }
.unlock-features { margin-top: 24px; text-align: left; }
.unlock-feature { display: flex; gap: 12px; align-items: center; padding: 11px 0; border-bottom: 0.5px solid var(--border); font-size: 14px; color: var(--jet); }
.unlock-feature:last-child { border-bottom: none; }
.unlock-feature-icon { font-size: 17px; flex-shrink: 0; }
.unlock-buy-btn {
  width: 100%; margin-top: 28px; padding: 14px 0;
  background: linear-gradient(135deg, var(--accent), var(--purple));
  color: #fff; border: none; border-radius: 14px;
  font-size: 16px; font-weight: 500; cursor: pointer; transition: opacity 0.2s;
}
.unlock-buy-btn:hover { opacity: 0.92; }
.unlock-note { font-size: 12px; color: var(--sub); margin-top: 10px; }

/* History Modal */
#history-modal { display: none; position: fixed; inset: 0; z-index: 400; align-items: center; justify-content: center; }
#history-modal.show { display: flex; animation: fadeIn 0.3s ease; }
.history-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); cursor: pointer; }
.history-card {
  position: relative; z-index: 1;
  background: rgba(255,255,255,0.92); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
  border-radius: 24px; padding: 32px 40px; max-width: 500px; width: 90%; max-height: 70vh;
  box-shadow: 0 24px 80px rgba(0,0,0,0.12); overflow-y: auto;
}
.history-close { position: absolute; top: 16px; right: 16px; background: none; border: none; cursor: pointer; padding: 4px; color: var(--sub); z-index: 10; }
.history-card h3 { font-size: 20px; font-weight: 600; color: var(--jet); margin-bottom: 20px; }
.history-list { display: flex; flex-direction: column; gap: 12px; }
.history-item {
  padding: 16px; border-radius: var(--radius-md); background: var(--off-white);
  cursor: pointer; transition: all 0.2s;
}
.history-item:hover { background: #fff; box-shadow: var(--shadow-md); }
.history-date { font-size: 13px; color: var(--sub); margin-bottom: 4px; }
.history-stats { font-size: 14px; color: var(--jet); font-weight: 500; }
.history-empty { text-align: center; color: var(--sub); padding: 40px 0; font-size: 14px; }

/* Toast */
#toast {
  position: fixed; bottom: 32px; left: 50%; z-index: 500;
  transform: translateX(-50%) translateY(20px);
  background: var(--jet); color: #fff; padding: 10px 24px; border-radius: 100px;
  font-size: 13px; font-weight: 500; pointer-events: none; opacity: 0; transition: all 0.3s ease;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* Footer */
.privacy-footer { text-align: center; padding: 48px 24px 40px; margin-top: 60px; border-top: 0.5px solid var(--border); }
.privacy-footer .badge { display: inline-flex; align-items: center; gap: 8px; margin-bottom: 14px; }
.privacy-footer .badge span { font-size: 12px; font-weight: 600; color: var(--jet); letter-spacing: 0.06em; }
.privacy-footer p { font-size: 13px; color: var(--sub); max-width: 460px; margin: 0 auto; line-height: 1.8; }
.privacy-footer .copy { font-size: 11px; color: rgba(0,0,0,0.15); margin-top: 28px; }
.reset-btn { margin-top: 8px; padding: 0; background: none; border: none; cursor: pointer; font-size: 13px; color: var(--accent); }
.reset-btn:hover { text-decoration: underline; }

/* ═══ TRUST & TRUTH SECTION ═══ */
#trust-section {
  background: var(--white);
  padding: 80px 24px;
  position: relative;
  z-index: 2;
}
.trust-container {
  max-width: 1080px;
  margin: 0 auto;
}
.trust-header {
  text-align: center;
  margin-bottom: 80px;
}
.trust-header h2 {
  font-size: clamp(32px, 6vw, 56px);
  font-weight: 700;
  letter-spacing: -0.04em;
  color: var(--jet);
  margin-bottom: 24px;
  opacity: 0;
  animation: fadeSlide 0.8s var(--ease-out) forwards;
}
.trust-tagline {
  font-size: clamp(13px, 2vw, 15px);
  color: var(--sub);
  font-weight: 400;
  opacity: 0;
  animation: fadeSlide 0.8s var(--ease-out) 0.2s forwards;
}
.trust-description {
  font-size: 15px;
  color: var(--jet);
  line-height: 1.8;
  max-width: 680px;
  margin: 16px auto 0;
  opacity: 0;
  animation: fadeSlide 0.8s var(--ease-out) 0.4s forwards;
}

/* Trust sections with fade-in */
.trust-content-block {
  margin-bottom: 60px;
  padding: 48px;
  border-radius: var(--radius-lg);
  background: var(--off-white);
}
.trust-content-block.fade-in-section {
  opacity: 0;
  transform: translateY(32px);
}
.trust-content-block.fade-in-section.visible {
  opacity: 1;
  transform: translateY(0);
  transition: opacity 0.9s cubic-bezier(.16,1,.3,1), transform 0.9s cubic-bezier(.16,1,.3,1);
  background: var(--white);
}

/* Comparison Table */
.comparison-table {
  width: 100%;
  border-collapse: collapse;
  margin: 32px 0;
}
.comparison-table th,
.comparison-table td {
  padding: 16px;
  text-align: left;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}
.comparison-table th {
  background: var(--off-white);
  font-weight: 600;
  color: var(--jet);
}
.comparison-table tr:last-child td {
  border-bottom: none;
}
.comparison-table td:first-child {
  font-weight: 500;
  color: var(--jet);
  width: 35%;
}
.comparison-table td:nth-child(2) {
  color: var(--jet);
  font-weight: 400;
}
.comparison-table td:nth-child(3) {
  color: var(--sub);
  font-weight: 400;
}
.table-icon {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}
.table-icon.safe { color: var(--green); }
.table-icon.risk { color: var(--red); }

/* Ban Warning Card */
.ban-warning {
  border-left: 4px solid var(--red);
  padding: 32px;
  background: rgba(255,59,48,0.05);
  border-radius: var(--radius-md);
  margin: 40px 0;
}
.ban-warning h3 {
  font-size: 16px;
  font-weight: 700;
  color: var(--jet);
  letter-spacing: 0.05em;
  margin-bottom: 16px;
}
.ban-warning p {
  font-size: 14px;
  color: var(--jet);
  line-height: 1.8;
  margin-bottom: 12px;
}
.ban-warning p:last-child {
  margin-bottom: 0;
  font-weight: 500;
  color: var(--red);
}

/* Fraud Education */
.fraud-section {
  background: linear-gradient(135deg, rgba(88,86,214,0.04), rgba(0,113,227,0.04));
  padding: 32px;
  border-radius: var(--radius-md);
  border: 1px solid rgba(0,113,227,0.1);
}
.fraud-section h3 {
  font-size: 16px;
  font-weight: 700;
  color: var(--jet);
  letter-spacing: 0.05em;
  margin-bottom: 12px;
}
.fraud-section p {
  font-size: 14px;
  color: var(--jet);
  line-height: 1.8;
  margin-bottom: 12px;
}
.fraud-section p:last-child {
  margin-bottom: 0;
}

/* ═══ SHARE BUTTONS ═══ */
.share-actions {
  display: flex;
  gap: 8px;
  justify-content: center;
  margin-top: 20px;
  flex-wrap: wrap;
}
.share-btn-social {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 18px;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(0,0,0,0.06);
  background: var(--off-white);
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  color: var(--sub);
  text-decoration: none;
  transition: all 0.2s;
  white-space: nowrap;
}
.share-btn-social:hover {
  background: #fff;
  border-color: rgba(0,0,0,0.1);
  color: var(--jet);
}
.share-btn-social svg {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

/* ═══ KEYFRAMES ═══ */
@keyframes fadeIn { from { opacity:0 } to { opacity:1 } }
@keyframes fadeSlide { from { opacity:0; transform:translateY(8px) } to { opacity:1; transform:translateY(0) } }
@keyframes gentleFloat { 0%,100% { transform:translateY(0) } 50% { transform:translateY(-6px) } }
@keyframes subtlePulse { 0%,100% { opacity:0.5 } 50% { opacity:1 } }

/* ═══ SVG LOGO ANIMATIONS ═══ */
@keyframes orbitDraw {
  from { stroke-dashoffset: var(--circumference); opacity: 0; }
  5% { opacity: 1; }
  to { stroke-dashoffset: 0; opacity: 1; }
}
@keyframes irisBounce {
  0% { transform: scale(0); opacity: 0; }
  60% { transform: scale(1.06); }
  80% { transform: scale(0.98); }
  100% { transform: scale(1); opacity: 1; }
}
@keyframes dotAppear {
  from { opacity: 0; transform: scale(0); }
  to { opacity: 1; transform: scale(1); }
}
@keyframes logoTextReveal {
  from { opacity: 0; transform: translateY(8px); letter-spacing: 0.3em; }
  to { opacity: 0.3; transform: translateY(0); letter-spacing: -0.03em; }
}
@keyframes lightSweep {
  0% { opacity: 0; transform: rotate(-30deg); }
  20% { opacity: 0.15; }
  100% { opacity: 0; transform: rotate(330deg); }
}

/* ═══ TRUST SECTION ANIMATIONS ═══ */
.fade-in-section {
  opacity: 0;
  transform: translateY(32px);
}
.fade-in-section.visible {
  opacity: 1;
  transform: translateY(0);
  transition: opacity 0.9s cubic-bezier(.16,1,.3,1), transform 0.9s cubic-bezier(.16,1,.3,1);
}

/* ═══ RESPONSIVE ═══ */
@media (max-width: 480px) {
  .stats-grid { gap: 8px; }
  .stat-card { padding: 18px 14px; }
  .stat-value { font-size: 28px; }
  .sort-btn span.label, .copy-btn span.label, .share-btn span.label { display: none; }
  .user-actions { opacity: 1; }
  .guide-step { padding: 14px 18px; }
  .upload-zone { padding: 40px 24px; }
  .unlock-card { padding: 36px 24px; }
  .auth-card { padding: 36px 24px; }
  .history-card { padding: 24px 20px; }
}
</style>
</head>
<body>

<!-- ═══════════════════════════════════════
     HERO: The Reflection Lens
     ═══════════════════════════════════════ -->
<section id="hero-section">
  <canvas id="lens-canvas"></canvas>

  <div class="hero-overlay">
    <div class="hero-logo">
      <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" style="--circumference:502.65">
        <!-- Outer orbit circle -->
        <circle cx="100" cy="100" r="80" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2" style="stroke-dasharray:502.65;stroke-dashoffset:502.65;animation:orbitDraw 1s ease 0s forwards"/>
        <!-- Inner iris circles -->
        <g style="animation:irisBounce 1s cubic-bezier(.16,1,.3,1) 0.5s forwards;transform-origin:100px 100px;opacity:0">
          <circle cx="100" cy="100" r="45" fill="none" stroke="rgba(255,255,255,0.25)" stroke-width="1.5"/>
          <circle cx="100" cy="100" r="38" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="1"/>
        </g>
        <!-- Center dot -->
        <circle cx="100" cy="100" r="4" fill="rgba(255,255,255,0.5)" style="animation:dotAppear 0.6s ease 0.8s forwards;opacity:0"/>
        <!-- Decorative dots around orbit -->
        <circle cx="180" cy="100" r="2.5" fill="rgba(255,255,255,0.3)" style="animation:dotAppear 0.5s ease 0.6s forwards;opacity:0"/>
        <circle cx="20" cy="100" r="2.5" fill="rgba(255,255,255,0.3)" style="animation:dotAppear 0.5s ease 0.7s forwards;opacity:0"/>
        <circle cx="100" cy="20" r="2.5" fill="rgba(255,255,255,0.3)" style="animation:dotAppear 0.5s ease 0.8s forwards;opacity:0"/>
        <circle cx="100" cy="180" r="2.5" fill="rgba(255,255,255,0.3)" style="animation:dotAppear 0.5s ease 0.9s forwards;opacity:0"/>
        <circle cx="142" cy="58" r="2" fill="rgba(255,255,255,0.25)" style="animation:dotAppear 0.5s ease 0.85s forwards;opacity:0"/>
        <circle cx="58" cy="142" r="2" fill="rgba(255,255,255,0.25)" style="animation:dotAppear 0.5s ease 0.95s forwards;opacity:0"/>
        <!-- Light sweep overlay -->
        <defs>
          <radialGradient id="lightSweep" cx="50%" cy="50%">
            <stop offset="0%" style="stop-color:rgba(255,255,255,0.1)"/>
            <stop offset="100%" style="stop-color:rgba(255,255,255,0)"/>
          </radialGradient>
        </defs>
        <circle cx="100" cy="100" r="100" fill="url(#lightSweep)" style="animation:lightSweep 1s ease-in 1.2s forwards;opacity:0"/>
      </svg>
      <span class="hero-logo-text">mieta</span>
    </div>
    <button class="hero-pro-btn" onclick="Mieta.handleProButtonClick()">mieta+</button>

    <div class="hero-center-logo">
      <svg class="logo-svg" width="200" height="170" viewBox="0 0 200 170" fill="none"
           style="overflow:visible;">
        <!-- Outer Orbit Circle -->
        <circle cx="100" cy="84" r="68" stroke="#FFF" stroke-width="1.6" fill="none"
                stroke-dasharray="427.26" stroke-dashoffset="427.26"
                style="animation:hOrbitDraw 1.0s var(--ease-out) 0s forwards;transform-origin:100px 84px;opacity:0;"/>
        <!-- Orbit Dot (top-left) -->
        <circle cx="52.4" cy="35" r="4.4" fill="#FFF"
                style="animation:hDotSlide 0.8s var(--ease-out) 0.15s forwards;opacity:0;transform-origin:52.4px 35px;"/>
        <!-- Decorative Dots -->
        <circle cx="150.5" cy="134.5" r="2.64" fill="rgba(255,255,255,0.3)"
                style="animation:hDotSlide 0.6s var(--ease-out) 0.30s forwards;opacity:0;"/>
        <circle cx="54.3" cy="129.7" r="2.64" fill="rgba(255,255,255,0.3)"
                style="animation:hDotSlide 0.6s var(--ease-out) 0.42s forwards;opacity:0;"/>
        <circle cx="31" cy="58.9" r="2.64" fill="rgba(255,255,255,0.3)"
                style="animation:hDotSlide 0.6s var(--ease-out) 0.54s forwards;opacity:0;"/>
        <circle cx="144.6" cy="30.9" r="2.64" fill="rgba(255,255,255,0.3)"
                style="animation:hDotSlide 0.6s var(--ease-out) 0.66s forwards;opacity:0;"/>
        <!-- Connecting Lines -->
        <line x1="150.5" y1="134.5" x2="54.3" y2="129.7" stroke="rgba(255,255,255,0.3)" stroke-width="0.8"
              style="animation:hLineFade 0.8s var(--ease-out) 0.5s forwards;opacity:0;"/>
        <line x1="31" y1="58.9" x2="144.6" y2="30.9" stroke="rgba(255,255,255,0.3)" stroke-width="0.8"
              style="animation:hLineFade 0.8s var(--ease-out) 0.65s forwards;opacity:0;"/>
        <!-- Inner Circle (Iris - outer) -->
        <circle cx="100" cy="84" r="44" stroke="#FFF" stroke-width="1.92" fill="none"
                style="animation:hIrisScale 0.9s var(--ease-out) 0.5s forwards;opacity:0;transform-origin:100px 84px;"/>
        <!-- Inner Circle (Iris - inner, dashed) -->
        <circle cx="100" cy="84" r="36" stroke="#FFF" stroke-width="1.28" fill="none"
                stroke-dasharray="18 9"
                style="animation:hIrisScale2 0.8s var(--ease-out) 0.65s forwards;opacity:0;transform-origin:100px 84px;"/>
        <!-- Light Sweep (fan) -->
        <path d="M 100 84 L 124 55.4 A 37.4 37.4 0 0 0 87.2 48.9 Z"
              stroke="#FFF" stroke-width="0.96" fill="rgba(255,255,255,0.04)"
              stroke-linecap="round"
              style="animation:hLightSweep 0.9s var(--ease-out) 1.2s forwards;opacity:0;transform-origin:100px 84px;"/>
        <!-- Center Dot -->
        <circle cx="100" cy="84" r="5.28" fill="#FFF"
                style="animation:hCenterDot 0.5s var(--ease-out) 0.8s forwards;opacity:0;transform-origin:100px 84px;"/>
      </svg>
      <div class="hero-logo-type">mieta</div>
      <div class="hero-logo-sub">The Reflection of Connection</div>
    </div>

    <div class="hero-cta">
      <button class="hero-cta-btn" onclick="Mieta.enterApp()" ontouchend="this.click()">
        フォロー関係を解析する
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
    </div>

    <div style="position:absolute;bottom:clamp(60px,10vh,100px);left:50%;transform:translateX(-50%);font-size:9px;color:rgba(255,255,255,0.08);letter-spacing:0.1em;pointer-events:none" id="hero-version"></div>
    <div class="hero-scroll-hint">
      <svg width="20" height="28" viewBox="0 0 20 28" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="1.5">
        <rect x="1" y="1" width="18" height="26" rx="9"/>
        <line x1="10" y1="7" x2="10" y2="12" stroke-linecap="round">
          <animate attributeName="y1" values="7;10;7" dur="2s" repeatCount="indefinite"/>
          <animate attributeName="y2" values="12;15;12" dur="2s" repeatCount="indefinite"/>
          <animate attributeName="opacity" values="1;0.3;1" dur="2s" repeatCount="indefinite"/>
        </line>
      </svg>
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════
     TRUST & TRUTH SECTION
     ═══════════════════════════════════════ -->
<section id="trust-section">
  <div class="trust-container">
    <div class="trust-header">
      <h2 class="fade-in-section">TRUST & TRUTH</h2>
      <p class="trust-tagline fade-in-section">安全であること。それが、すべての前提。</p>
      <p class="trust-description fade-in-section">あなたのInstagramアカウントは、あなたの人間関係そのもの。mietaは、その価値を誰よりも理解しています。</p>
    </div>

    <!-- Comparison Table -->
    <div class="trust-content-block fade-in-section">
      <h3 style="font-size:18px;font-weight:700;color:var(--jet);margin-bottom:24px;letter-spacing:0.05em">THE HONEST COMPARISON</h3>
      <table class="comparison-table">
        <thead>
          <tr>
            <th style="text-align:left">特性</th>
            <th style="text-align:left;color:var(--green)">mieta (Safety First)</th>
            <th style="text-align:left;color:var(--red)">他社アプリ (Common Risks)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ログイン</td>
            <td><span class="table-icon safe">✓ 一切不要</span><br><small style="color:var(--sub)">ZIP手動読み込みのみ</small></td>
            <td><span class="table-icon risk">✕ ID/PASS入力必須</span><br><small style="color:var(--sub)">不正アクセス扱いで即BAN リスク</small></td>
          </tr>
          <tr>
            <td>BANリスク</td>
            <td><span class="table-icon safe">✓ 0%</span><br><small style="color:var(--sub)">Instagram公式規約に完全準拠</small></td>
            <td><span class="table-icon risk">✕ 高リスク</span><br><small style="color:var(--sub)">規約違反による永久凍結の可能性</small></td>
          </tr>
          <tr>
            <td>料金</td>
            <td><span class="table-icon safe">✓ ¥300/1回</span><br><small style="color:var(--sub)">買い切り・自動更新なし</small></td>
            <td><span class="table-icon risk">✕ 月額¥1,500〜</span><br><small style="color:var(--sub)">巧妙に隠された自動サブスクリプション</small></td>
          </tr>
          <tr>
            <td>データの行き先</td>
            <td><span class="table-icon safe">✓ デバイス内のみ</span><br><small style="color:var(--sub)">サーバーへの送信は一切ありません</small></td>
            <td><span class="table-icon risk">✕ 海外サーバー</span><br><small style="color:var(--sub)">あなたのデータは送信・蓄積されます</small></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- BAN Warning Card -->
    <div class="trust-content-block fade-in-section">
      <div class="ban-warning">
        <h3>ACCOUNT SAFETY NOTICE</h3>
        <p>Instagramのアカウントを、安易なアプリに預けないでください。IDとパスワードを要求する全てのサードパーティアプリは、公式規約違反による永久凍結（BAN）の引き金となります。</p>
        <p>mietaは、あなたのログイン情報を1文字も知りません。それが、私たちが提供する最大の安心です。</p>
      </div>
    </div>

    <!-- Fraud Education -->
    <div class="trust-content-block fade-in-section">
      <div class="fraud-section">
        <h3>THE TRUTH ABOUT "FOOTPRINT" APPS</h3>
        <p><strong>「足跡が見える」という嘘について。</strong></p>
        <p>Instagram公式APIには、閲覧履歴（足跡）を外部に提供する機能は存在しません。「誰がプロフィールを見たか教える」と謳うアプリは、例外なくあなたのデータを盗むための詐欺です。</p>
      </div>
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════
     APP: Service Screens
     ═══════════════════════════════════════ -->
<div id="app-section">
  <!-- Background -->
  <div id="bg-blobs">
    <div class="blob" style="width:680px;height:680px;left:-10%;top:-5%;background:rgba(0,113,227,0.06);--dur:22s;--delay:0s;--tx1:30px;--ty1:-40px;--s1:1.08;--tx2:-20px;--ty2:20px;--s2:0.95;--tx3:15px;--ty3:-25px;--s3:1.04"></div>
    <div class="blob" style="width:520px;height:520px;right:-8%;top:10%;background:rgba(88,86,214,0.05);--dur:18s;--delay:2s;--tx1:-40px;--ty1:30px;--s1:1.1;--tx2:25px;--ty2:-15px;--s2:0.96;--tx3:-10px;--ty3:20px;--s3:1.02"></div>
    <div class="blob" style="width:800px;height:800px;left:20%;bottom:-20%;background:rgba(0,113,227,0.04);--dur:26s;--delay:4s;--tx1:20px;--ty1:35px;--s1:0.92;--tx2:-35px;--ty2:-20px;--s2:1.06;--tx3:10px;--ty3:15px;--s3:1"></div>
    <div class="blob" style="width:400px;height:400px;right:15%;bottom:20%;background:rgba(175,130,255,0.05);--dur:20s;--delay:1s;--tx1:-25px;--ty1:-30px;--s1:1.05;--tx2:20px;--ty2:25px;--s2:0.97;--tx3:-15px;--ty3:10px;--s3:1.03"></div>
  </div>
  <div id="noise-overlay"></div>

  <!-- Navbar -->
  <nav id="navbar">
    <div class="nav-inner">
      <button class="nav-logo" onclick="Mieta.reset()">
        <div class="nav-logo-svg">
          <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
            <circle cx="100" cy="100" r="80" fill="none" stroke="rgba(29,29,31,0.4)" stroke-width="1.5"/>
            <circle cx="100" cy="100" r="45" fill="none" stroke="rgba(29,29,31,0.25)" stroke-width="1"/>
            <circle cx="100" cy="100" r="4" fill="rgba(29,29,31,0.5)"/>
            <circle cx="180" cy="100" r="1.8" fill="rgba(29,29,31,0.3)"/>
            <circle cx="20" cy="100" r="1.8" fill="rgba(29,29,31,0.3)"/>
            <circle cx="100" cy="20" r="1.8" fill="rgba(29,29,31,0.3)"/>
            <circle cx="100" cy="180" r="1.8" fill="rgba(29,29,31,0.3)"/>
          </svg>
        </div>
      </button>
      <div class="nav-right">
        <button class="nav-link" onclick="Mieta.goToScreen('guide')">使い方</button>
        <div id="nav-auth" style="display:none;">
          <div class="nav-user-info">
            <span class="nav-user-email" id="nav-email"></span>
            <button class="nav-logout-btn" onclick="Mieta.logout()">ログアウト</button>
          </div>
        </div>
        <button class="nav-pro" id="nav-pro-btn" onclick="Mieta.handleProButtonClick()">mieta+</button>
      </div>
    </div>
  </nav>

  <!-- Screen: Guide -->
  <div id="screen-guide" class="screen">
    <div class="guide-header">
      <h1>つながりを、<br>透明に。</h1>
      <p>Instagramのフォロー関係を、あなたのブラウザだけで解析。</p>
    </div>
    <div class="guide-card">
      <a class="guide-deeplink" href="https://accountscenter.instagram.com/info_and_permissions/dyi/" target="_blank" rel="noopener">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
        Instagramのデータダウンロードページを開く
      </a>
      <div class="guide-steps">
        <div class="guide-step"><div class="step-num">1</div><div class="step-text">上のリンクからInstagramのデータダウンロードページを開きます</div></div>
        <div class="guide-step"><div class="step-num">2</div><div class="step-text">「情報をダウンロード」または「Download your information」を選択<small>※ アカウントセンターにログインが必要です</small></div></div>
        <div class="guide-step"><div class="step-num">3</div><div class="step-text">対象アカウントを選択し「一部の情報」を選びます</div></div>
        <div class="guide-step"><div class="step-num">4</div><div class="step-text">「フォロワーとフォロー中」のみにチェックを入れます<small>※ 必要最小限のデータだけで解析できます</small></div></div>
        <div class="guide-step"><div class="step-num">5</div><div class="step-text">形式は必ず <strong>JSON</strong> を選択してダウンロードをリクエスト</div></div>
        <div class="guide-step"><div class="step-num">6</div><div class="step-text">メールでZIPファイルを受信したら、次のステップへ進みます<small>※ 通常数分〜48時間で届きます</small></div></div>
      </div>
    </div>
    <button class="guide-next" onclick="Mieta.goToScreen('upload')">ZIPファイルをアップロードする →</button>
  </div>

  <!-- Screen: Upload -->
  <div id="screen-upload" class="screen">
    <button class="back-link" onclick="Mieta.goToScreen('guide')">
      <svg width="8" height="14" viewBox="0 0 8 14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M7 1L1 7l6 6"/></svg>
      ガイドに戻る
    </button>
    <div class="upload-header">
      <h2>データをアップロード</h2>
      <p>Instagramから受け取ったZIPファイルを選択してください</p>
    </div>
    <div class="upload-zone" id="upload-zone">
      <input type="file" id="file-input" accept=".zip,.json">
      <div class="upload-icon-wrap">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#86868B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 16V4M12 4l-4 4M12 4l4 4M4 14v4a2 2 0 002 2h12a2 2 0 002-2v-4"/></svg>
      </div>
      <p class="upload-title">ZIPファイルをドロップ</p>
      <p class="upload-sub">またはクリックして選択</p>
      <span class="upload-formats">Instagram JSON形式 (.zip / .json)</span>
    </div>
    <div class="error-msg" id="error-msg"></div>
    <div class="os-guide">
      <div class="os-tabs">
        <button class="os-tab active" data-os="iphone" onclick="Mieta.switchOS('iphone')">iPhone</button>
        <button class="os-tab" data-os="android" onclick="Mieta.switchOS('android')">Android</button>
      </div>
      <div class="os-hint" id="os-hint-iphone"><strong>ファイルの場所（iPhone）</strong><br>メールアプリでZIPを受信 → 添付ファイルを長押し →「"ファイル"に保存」。「ブラウズ」タブから保存先を確認してください。</div>
      <div class="os-hint" id="os-hint-android" style="display:none"><strong>ファイルの場所（Android）</strong><br>GmailでZIPを受信 → 添付ファイルをタップしてダウンロード。「ファイル」アプリ →「ダウンロード」フォルダに保存されています。</div>
    </div>
    <div class="security-badge">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#0071E3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
      <span>完全にブラウザ内で処理。データはどこにも送信されません。</span>
    </div>
  </div>

  <!-- Screen: Results -->
  <div id="screen-results" class="screen">
    <div class="results-inner">
      <div class="results-header">
        <h2>解析が完了しました</h2>
        <p id="results-summary"></p>
        <div class="results-actions">
          <button class="reset-btn" onclick="Mieta.reset()">新しいファイルを解析</button>
          <button class="results-history-btn" id="history-btn" onclick="Mieta.openHistory()" style="display:none;">過去の解析結果</button>
        </div>
        <div class="share-actions" id="share-actions" style="display:none;">
          <a class="share-btn-social" id="share-line" href="#" target="_blank" rel="noopener">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12c0 4.99 3.65 9.15 8.43 9.9.1.01.2.01.29 0 .55-.09 1.08-.23 1.59-.42-.06-.16-.1-.34-.1-.53 0-1.1.9-2 2-2h1.83c1.1 0 2 .9 2 2 0 1.1.9 2 2 2s2-.9 2-2c0-4.99-3.65-9.15-8.43-9.9-.1-.01-.2-.01-.29 0C4.86 3.15 2 6.48 2 10.5v1.5c0 1.1.9 2 2 2h1.83c1.1 0 2-.9 2-2 0-1.1.9-2 2-2s2 .9 2 2 .9 2 2 2h1.83c1.1 0 2 .9 2 2 0 1.1.9 2 2 2s2-.9 2-2c0-4.99-3.65-9.15-8.43-9.9z"/></svg>
            LINE
          </a>
          <a class="share-btn-social" id="share-x" href="#" target="_blank" rel="noopener">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24h-6.657l-5.207-6.807-5.974 6.807H2.882l7.732-8.835L1.227 2.25h6.836l4.709 6.231 5.45-6.231zM17.15 18.75h1.828L5.856 4.051H3.914l13.236 14.699z"/></svg>
            X
          </a>
          <button class="share-btn-social" onclick="Mieta.copyShareText()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            <span id="copy-share-label">コピー</span>
          </button>
        </div>
      </div>
      <div class="stats-grid" id="stats-grid"></div>
      <div class="result-tabs" id="result-tabs"></div>
      <div class="list-toolbar">
        <div class="search-wrap">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#86868B" stroke-width="1.5" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" class="search-input" id="search-input" placeholder="ユーザー名を検索…" oninput="Mieta.renderList()">
        </div>
        <button class="sort-btn" id="sort-btn" onclick="Mieta.cycleSort()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M3 6h18M3 12h12M3 18h6"/></svg>
          <span class="label">名前順</span>
        </button>
        <button class="copy-btn" onclick="Mieta.copyList()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
          <span class="label">コピー</span>
        </button>
        <button class="share-btn" onclick="Mieta.shareList()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v6a2 2 0 002 2h12a2 2 0 002-2v-6M12 3v12M12 3l4 4M12 3L8 7"/></svg>
          <span class="label">共有</span>
        </button>
      </div>
      <div class="user-list" id="user-list"></div>
      <div class="premium-banner" id="premium-banner">
        <h4>すべてのユーザーを表示</h4>
        <p id="premium-desc"></p>
        <button class="premium-buy" onclick="Mieta.handleProButtonClick()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.27 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>
          mieta+ でロック解除
        </button>
        <p class="premium-price">¥330（税込）· 買い切り</p>
      </div>
      <div class="privacy-footer">
        <div class="badge">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#0071E3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
          <span>Zero-Knowledge Design</span>
        </div>
        <p>mietaは、あなたのInstagramデータをサーバーに保存・送信・閲覧することは物理的に不可能です。すべての計算は、今お使いのブラウザ内で完結しました。</p>
        <p class="copy">© 2026 mieta. All rights reserved.</p>
      </div>
    </div>
  </div>
</div>

<!-- Overlays -->
<div id="analyzing-overlay">
  <div class="analyzing-bar"><div class="analyzing-bar-fill" id="analyzing-bar-fill"></div></div>
  <p class="analyzing-status" id="analyzing-status">準備中…</p>
  <p class="analyzing-pct"><span id="analyzing-pct-num">0</span><span>%</span></p>
</div>

<div id="auth-modal">
  <div class="auth-backdrop" onclick="Mieta.closeAuth()"></div>
  <div class="auth-card">
    <button class="auth-close" onclick="Mieta.closeAuth()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    <h3 id="auth-title">ログイン</h3>
    <p id="auth-subtitle">アカウントにログインしてプレミアムを購入</p>
    <div class="auth-toggle">
      <button class="auth-toggle-btn active" onclick="Mieta.switchAuthMode('login')">ログイン</button>
      <button class="auth-toggle-btn" onclick="Mieta.switchAuthMode('signup')">サインアップ</button>
    </div>
    <div class="auth-form">
      <input type="email" class="auth-input" id="auth-email" placeholder="メールアドレス">
      <input type="password" class="auth-input" id="auth-password" placeholder="パスワード">
      <div class="auth-error" id="auth-error"></div>
      <button class="auth-submit" id="auth-submit" onclick="Mieta.submitAuth()">ログイン</button>
    </div>
  </div>
</div>

<div id="unlock-modal">
  <div class="unlock-backdrop" onclick="Mieta.closeUnlock()"></div>
  <div class="unlock-card">
    <button class="unlock-close" onclick="Mieta.closeUnlock()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    <div class="unlock-badge">mieta+</div>
    <h3>すべてのつながりを見る</h3>
    <p>無料版では各カテゴリ最大表示数に制限があります。<br>mieta+ ですべてのリストをロック解除。</p>
    <div class="unlock-features">
      <div class="unlock-feature"><span class="unlock-feature-icon">🔓</span>全ユーザーリストを表示</div>
      <div class="unlock-feature"><span class="unlock-feature-icon">📋</span>リスト全体のコピー・共有</div>
      <div class="unlock-feature"><span class="unlock-feature-icon">🔍</span>完全な検索・ソート機能</div>
      <div class="unlock-feature"><span class="unlock-feature-icon">♾️</span>買い切り — 追加料金なし</div>
    </div>
    <button class="unlock-buy-btn" onclick="Mieta.purchasePremium()">¥330 で購入する</button>
    <p class="unlock-note">※ Stripe Checkoutにリダイレクトします</p>
  </div>
</div>

<div id="history-modal">
  <div class="history-backdrop" onclick="Mieta.closeHistory()"></div>
  <div class="history-card">
    <button class="history-close" onclick="Mieta.closeHistory()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    <h3>過去の解析結果</h3>
    <div class="history-list" id="history-list"></div>
  </div>
</div>

<div id="toast"></div>

<!-- ═══════════════════════════════════════════
     JavaScript: Lens Animation + Full Service Logic + Supabase
     ═══════════════════════════════════════════ -->
<script>
const Mieta = (function(){
  'use strict';

  /* ═══ CONSTANTS ═══ */
  const BUILD_VERSION = 'v6.0-trust-2026-02-22';
  const PREMIUM_KEY = 'mieta_premium';
  const SORT_MODES = ['name','newest','oldest'];
  const SORT_LABELS = { name:'名前順', newest:'新しい順', oldest:'古い順' };
  const CATEGORIES = [
    { key:'unrequited', label:'フォロバなし', color:'#FF3B30', desc:'あなたがフォロー中だが、相手はしていない' },
    { key:'fans',       label:'片思われ',     color:'#FF9500', desc:'相手があなたをフォロー中だが、あなたはしていない' },
    { key:'mutual',     label:'相互フォロー', color:'#34C759', desc:'お互いにフォロー中' },
  ];
  const DUMMY_NAMES = ['?????_user','???_private','????_ig','?????_2024','???_gram','????_snap','?????_me','???_daily'];

  /* ═══ SUPABASE CONFIG ═══ */
  const SUPABASE_URL = 'https://ztmukyaxgymrlvzxnhrs.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0bXVreWF4Z3ltcmx2enhuaHJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MjY0NTgsImV4cCI6MjA4NzMwMjQ1OH0.MxAk5-luuJ6JE3SPDq82Eh-JzZUMKAcJ61FpRs67ftU';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ═══ STATE ═══ */
  let state = {
    phase: 'hero',        // hero | app
    screen: 'guide',
    data: null,
    activeTab: 'unrequited',
    sortMode: 'name',
    isPremium: localStorage.getItem(PREMIUM_KEY) === 'true',
    currentSession: null,
    currentUser: null,
    authMode: 'login', // login | signup
  };

  const $ = (s) => document.querySelector(s);
  const $$ = (s) => document.querySelectorAll(s);

  /* ═══ UTILITIES ═══ */
  function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
  function normalizeUsername(u){ return (u||'').trim().toLowerCase(); }
  function deduplicateUsers(users){
    const seen = new Set();
    return users.filter(u => { const k=normalizeUsername(u.username); if(seen.has(k)) return false; seen.add(k); return true; });
  }
  function avatarColor(name){
    let h=0; for(let i=0;i<name.length;i++) h=name.charCodeAt(i)+((h<<5)-h);
    return `hsl(${Math.abs(h)%360},55%,65%)`;
  }
  function formatDate(ts){
    if(!ts) return '';
    return new Date(ts*1000).toLocaleDateString('ja-JP',{year:'numeric',month:'short',day:'numeric'});
  }
  function toast(msg){
    const el=$('#toast'); el.textContent=msg; el.classList.add('show');
    setTimeout(()=>el.classList.remove('show'),2200);
  }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  /* ═══════════════════════════════════════════
     THE REFLECTION LENS — Canvas Animation
     ═══════════════════════════════════════════ */
  const LENS = {
    NODE_COUNT: 28, EDGE_MAX_DIST: 180,
    ORBIT_BASE: 260, ORBIT_VAR: 140,
    SPD_MIN: 0.0003, SPD_MAX: 0.0012,
    LENS_R_RATIO: 0.18, LENS_MIN: 120, LENS_MAX: 220,
    MAGNIFY: 1.22, DISTORT: 0.08,
    EDGE_OUT_A: 0.06, EDGE_IN_A: 0.35,
    NODE_OUT_A: 0.18, NODE_IN_A: 0.95,
    BREATH_T: 12000, BREATH_S: 0.04,
    ROT_SPD: 0.00004, GLOW: 6,
  };

  let canvas, ctx, W, H, CX, CY, LENS_R, dpr, nodes=[], lensAnimId=null, lensStart=null;

  function initLens(){
    canvas = $('#lens-canvas');
    ctx = canvas.getContext('2d');
    resizeLens();
    window.addEventListener('resize', resizeLens);

    for(let i=0; i<LENS.NODE_COUNT; i++){
      nodes.push({
        angle: Math.random()*Math.PI*2,
        radius: LENS.ORBIT_BASE + (Math.random()-0.5)*2*LENS.ORBIT_VAR,
        speed: (LENS.SPD_MIN + Math.random()*(LENS.SPD_MAX-LENS.SPD_MIN)) * (Math.random()>0.5?1:-1),
        phase: Math.random()*Math.PI*2,
        eccX: 0.7+Math.random()*0.6, eccY: 0.7+Math.random()*0.6,
        drift: (Math.random()-0.5)*0.15,
        size: 2+Math.random()*2.5,
        x:0, y:0
      });
    }
    lensAnimId = requestAnimationFrame(renderLens);
  }

  function resizeLens(){
    dpr = window.devicePixelRatio||1;
    W = window.innerWidth; H = window.innerHeight;
    canvas.width = W*dpr; canvas.height = H*dpr;
    canvas.style.width = W+'px'; canvas.style.height = H+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
    CX=W/2; CY=H/2;
    LENS_R = Math.max(LENS.LENS_MIN, Math.min(LENS.LENS_MAX, Math.min(W,H)*LENS.LENS_R_RATIO));
  }

  function renderLens(ts){
    if(!lensStart) lensStart=ts;
    const t = ts-lensStart;
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);

    const vig=ctx.createRadialGradient(CX,CY,0,CX,CY,Math.max(W,H)*0.7);
    vig.addColorStop(0,'rgba(20,20,25,0)'); vig.addColorStop(1,'rgba(0,0,0,0.4)');
    ctx.fillStyle=vig; ctx.fillRect(0,0,W,H);

    const bS = 1+Math.sin(t/LENS.BREATH_T*Math.PI*2)*LENS.BREATH_S;
    const gR = t*LENS.ROT_SPD;

    for(const n of nodes){
      const a = n.angle + n.speed*t + Math.sin(t*0.0002+n.phase)*0.3;
      const r = n.radius + Math.sin(t*0.0004+n.phase)*20;
      const rx = CX + Math.cos(a)*r*n.eccX;
      const ry = CY + Math.sin(a)*r*n.eccY;
      const dx=rx-CX, dy=ry-CY;
      const cos=Math.cos(gR), sin=Math.sin(gR);
      n.x = CX+(dx*cos-dy*sin)*bS;
      n.y = CY+(dx*sin+dy*cos)*bS;
    }

    const cR = LENS_R*bS;

    ctx.save();
    ctx.beginPath(); ctx.rect(0,0,W,H); ctx.arc(CX,CY,cR,0,Math.PI*2,true); ctx.clip();
    for(let i=0;i<nodes.length;i++){
      for(let j=i+1;j<nodes.length;j++){
        const dx=nodes[i].x-nodes[j].x, dy=nodes[i].y-nodes[j].y;
        const d=Math.sqrt(dx*dx+dy*dy);
        if(d<LENS.EDGE_MAX_DIST){
          ctx.beginPath(); ctx.moveTo(nodes[i].x,nodes[i].y); ctx.lineTo(nodes[j].x,nodes[j].y);
          ctx.strokeStyle=`rgba(255,255,255,${LENS.EDGE_OUT_A*(1-d/LENS.EDGE_MAX_DIST)})`;
          ctx.lineWidth=0.5; ctx.stroke();
        }
      }
    }
    for(const n of nodes){
      ctx.beginPath(); ctx.arc(n.x,n.y,n.size,0,Math.PI*2);
      ctx.fillStyle=`rgba(255,255,255,${LENS.NODE_OUT_A})`; ctx.fill();
    }
    ctx.restore();

    const rA = 0.12+Math.sin(t*0.001)*0.04;
    const glowG=ctx.createRadialGradient(CX,CY,cR*0.92,CX,CY,cR*1.25);
    glowG.addColorStop(0,'rgba(255,255,255,0)'); glowG.addColorStop(0.5,'rgba(255,255,255,0.015)'); glowG.addColorStop(1,'rgba(255,255,255,0)');
    ctx.beginPath(); ctx.arc(CX,CY,cR*1.25,0,Math.PI*2); ctx.fillStyle=glowG; ctx.fill();

    const iF=ctx.createRadialGradient(CX,CY,0,CX,CY,cR);
    iF.addColorStop(0,'rgba(255,255,255,0.02)'); iF.addColorStop(0.7,'rgba(255,255,255,0.01)'); iF.addColorStop(1,'rgba(255,255,255,0.03)');
    ctx.beginPath(); ctx.arc(CX,CY,cR,0,Math.PI*2); ctx.fillStyle=iF; ctx.fill();

    ctx.beginPath(); ctx.arc(CX,CY,cR,0,Math.PI*2);
    ctx.strokeStyle=`rgba(255,255,255,${rA})`; ctx.lineWidth=1; ctx.stroke();
    ctx.beginPath(); ctx.arc(CX,CY,cR+4,0,Math.PI*2);
    ctx.strokeStyle=`rgba(255,255,255,${rA*0.3})`; ctx.lineWidth=0.5; ctx.stroke();

    ctx.save();
    ctx.beginPath(); ctx.arc(CX,CY,cR,0,Math.PI*2); ctx.clip();
    ctx.fillStyle='rgba(8,8,12,0.6)'; ctx.fillRect(CX-cR,CY-cR,cR*2,cR*2);

    const inner=[];
    for(const n of nodes){
      const dx=n.x-CX, dy=n.y-CY, d=Math.sqrt(dx*dx+dy*dy);
      if(d<=cR*1.3){
        const tt=Math.min(d/cR,1);
        const mag=LENS.MAGNIFY+LENS.DISTORT*tt*tt;
        inner.push({...n, lx:CX+dx*mag, ly:CY+dy*mag, t:tt});
      }
    }
    for(let i=0;i<inner.length;i++){
      for(let j=i+1;j<inner.length;j++){
        const dx=inner[i].x-inner[j].x, dy=inner[i].y-inner[j].y;
        const d=Math.sqrt(dx*dx+dy*dy);
        if(d<LENS.EDGE_MAX_DIST){
          const f=1-d/LENS.EDGE_MAX_DIST;
          const aT=(inner[i].t+inner[j].t)/2;
          ctx.beginPath(); ctx.moveTo(inner[i].lx,inner[i].ly); ctx.lineTo(inner[j].lx,inner[j].ly);
          ctx.strokeStyle=`rgba(255,255,255,${LENS.EDGE_IN_A*f*(1-aT*0.5)})`;
          ctx.lineWidth=1; ctx.stroke();
        }
      }
    }
    for(const n of inner){
      const a=LENS.NODE_IN_A*(1-n.t*0.4);
      const gr=n.size+LENS.GLOW*(1-n.t*0.5);
      const g=ctx.createRadialGradient(n.lx,n.ly,n.size*0.3,n.lx,n.ly,gr);
      g.addColorStop(0,`rgba(255,255,255,${a})`); g.addColorStop(0.4,`rgba(255,255,255,${a*0.6})`); g.addColorStop(1,'rgba(255,255,255,0)');
      ctx.beginPath(); ctx.arc(n.lx,n.ly,gr,0,Math.PI*2); ctx.fillStyle=g; ctx.fill();
      ctx.beginPath(); ctx.arc(n.lx,n.ly,n.size*1.15,0,Math.PI*2); ctx.fillStyle=`rgba(255,255,255,${a})`; ctx.fill();
    }
    ctx.restore();

    const sA=t*0.0008;
    for(let i=0;i<60;i++){
      const a=(i/60)*Math.PI*2;
      const s=0.03+0.04*Math.sin(a*3+sA);
      ctx.beginPath(); ctx.arc(CX+Math.cos(a)*cR,CY+Math.sin(a)*cR,1.5,0,Math.PI*2);
      ctx.fillStyle=`rgba(255,255,255,${s})`; ctx.fill();
    }

    if(state.phase==='hero') lensAnimId=requestAnimationFrame(renderLens);
  }

  function stopLens(){
    if(lensAnimId){ cancelAnimationFrame(lensAnimId); lensAnimId=null; }
  }

  /* ═══════════════════════════════════════════
     PHASE TRANSITION: Hero → App
     ═══════════════════════════════════════════ */
  function enterApp(){
    state.phase='app';
    const hero=$('#hero-section');
    const trust=$('#trust-section');
    hero.classList.add('hidden');
    if(trust) trust.style.display='none';
    setTimeout(()=>{
      stopLens();
      hero.style.display='none';
      document.body.style.background='var(--white)';
      $('#app-section').classList.add('active');
      $('#navbar').classList.add('active');
      $('#noise-overlay').classList.add('active');
      goToScreen('guide');
    },800);
  }

  function backToHero(){
    state.phase='hero';
    state.data=null; state.activeTab='unrequited'; state.sortMode='name';
    const si=$('#search-input'); if(si) si.value='';
    $('#error-msg').classList.remove('show');

    $$('.screen').forEach(s=>s.classList.remove('active','visible'));
    $('#app-section').classList.remove('active');
    $('#navbar').classList.remove('active');
    $('#noise-overlay').classList.remove('active');
    const trust=$('#trust-section'); if(trust) trust.style.display='';
    document.body.style.background='#000';

    const hero=$('#hero-section');
    hero.style.display=''; hero.classList.remove('hidden');
    lensStart=null;
    lensAnimId=requestAnimationFrame(renderLens);
  }

  /* ═══════════════════════════════════════════
     SCREEN MANAGEMENT
     ═══════════════════════════════════════════ */
  function goToScreen(name){
    state.screen=name;
    $$('.screen').forEach(s=>s.classList.remove('active','visible'));
    const target=$(`#screen-${name}`);
    target.classList.add('active');
    void target.offsetWidth;
    requestAnimationFrame(()=>target.classList.add('visible'));
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function switchOS(os){
    $$('.os-tab').forEach(t=>t.classList.toggle('active',t.dataset.os===os));
    $('#os-hint-iphone').style.display = os==='iphone'?'block':'none';
    $('#os-hint-android').style.display = os==='android'?'block':'none';
  }

  /* ═══════════════════════════════════════════
     DATA PROCESSING (v2 — robust multi-format)
     ═══════════════════════════════════════════ */

  function extractUsers(data){
    const users=[];
    function hrefToUsername(href){
      if(!href) return '';
      const m=href.match(/instagram\.com\/(?:_u\/)?([^/?#]+)/);
      return m ? m[1] : '';
    }
    function walk(obj){
      if(!obj||typeof obj!=='object') return;
      if(Array.isArray(obj)){ obj.forEach(walk); return; }

      let extracted=false;
      if(Array.isArray(obj.string_list_data)){
        obj.string_list_data.forEach(d=>{
          const username = d.value
            || (obj.title && typeof obj.title==='string' && obj.title.length>0 ? obj.title : '')
            || hrefToUsername(d.href);
          if(username){
            const cleanHref = (d.href||'').replace('/_u/','/')
              || `https://www.instagram.com/${username}`;
            users.push({ username, href:cleanHref, timestamp:d.timestamp||0 });
            extracted=true;
          }
        });
      }
      if(!extracted && obj.title && typeof obj.title==='string' && obj.title.length>0){
        const sld = Array.isArray(obj.string_list_data) && obj.string_list_data[0];
        const ts = sld ? (sld.timestamp||0) : (obj.timestamp||0);
        const href = sld && sld.href
          ? sld.href.replace('/_u/','/')
          : `https://www.instagram.com/${obj.title}`;
        users.push({ username:obj.title, href, timestamp:ts });
      }

      Object.values(obj).forEach(v=>{
        if(v && typeof v==='object') walk(v);
      });
    }
    walk(data);
    return deduplicateUsers(users);
  }

  function classifyFile(fn){
    const basename = fn.split('/').pop().toLowerCase();
    if(/^following(_\d+)?\.json$/.test(basename)) return 'following';
    if(/^followers(_\d+)?\.json$/.test(basename)) return 'followers';
    return null;
  }

  function classifyData(followers,following){
    const fwSet=new Set(followers.map(u=>normalizeUsername(u.username)));
    const fgSet=new Set(following.map(u=>normalizeUsername(u.username)));
    return {
      followers, following,
      unrequited: following.filter(u=>!fwSet.has(normalizeUsername(u.username))),
      fans: followers.filter(u=>!fgSet.has(normalizeUsername(u.username))),
      mutual: following.filter(u=>fwSet.has(normalizeUsername(u.username))),
    };
  }

  function detectTypeFromContent(json){
    if(!json||typeof json!=='object') return null;
    const keys = Object.keys(json);
    for(const k of keys){
      const kl = k.toLowerCase();
      if(kl==='relationships_following') return 'following';
      if(kl==='relationships_followers') return 'followers';
    }
    return null;
  }

  function calculateFreeLimit(){
    if(!state.data) return 3;
    const totalUnreq = state.data.unrequited.length;
    return Math.max(1, Math.ceil(totalUnreq * 0.2));
  }

  async function processFile(file){
    showAnalyzing();
    const diag = { files:[], errors:[], followersCount:0, followingCount:0 };
    try {
      let followers=[], following=[];
      if(file.name.toLowerCase().endsWith('.json')){
        updateProgress(0.3,'JSONを解析中…');
        const json=JSON.parse(await file.text());
        const users=extractUsers(json);
        let type=classifyFile(file.name);
        if(!type) type=detectTypeFromContent(json);
        if(type==='followers') followers=users;
        else if(type==='following') following=users;
        else throw new Error('SINGLE_JSON');
      } else if(file.name.toLowerCase().endsWith('.zip')){
        updateProgress(0.1,'ZIPを展開中…');
        const zip=await JSZip.loadAsync(file);
        const jsonFiles = Object.keys(zip.files).filter(fn=>fn.toLowerCase().endsWith('.json')&&!zip.files[fn].dir);
        updateProgress(0.2,`${jsonFiles.length}個のJSONファイルを検出…`);

        let step=0;
        for(const fn of jsonFiles){
          step++;
          updateProgress(0.2+0.4*(step/jsonFiles.length), `解析中: ${fn.split('/').pop()}`);
          let type=classifyFile(fn);
          let json;
          try{
            json=JSON.parse(await zip.files[fn].async('string'));
          }catch(parseErr){
            diag.errors.push(`JSON parse error: ${fn.split('/').pop()}`);
            continue;
          }
          if(!type) type=detectTypeFromContent(json);
          if(!type){
            diag.files.push({ name:fn.split('/').pop(), type:'skip', users:0 });
            continue;
          }
          try{
            const users=extractUsers(json);
            diag.files.push({ name:fn.split('/').pop(), type, users:users.length });
            if(type==='followers') followers=followers.concat(users);
            else following=following.concat(users);
          }catch(extractErr){
            diag.errors.push(`Extract error: ${fn.split('/').pop()} — ${extractErr.message}`);
          }
        }
        followers=deduplicateUsers(followers);
        following=deduplicateUsers(following);
      } else { throw new Error('INVALID_TYPE'); }

      diag.followersCount=followers.length;
      diag.followingCount=following.length;
      console.log('[mieta] Diagnosis:', JSON.stringify(diag, null, 2));

      updateProgress(0.65,'フォロワーデータを検証中…'); await sleep(250);

      if(!followers.length && !following.length){
        throw new Error('NO_DATA');
      }

      updateProgress(0.8,'カテゴリを分類中…'); await sleep(250);
      state.data=classifyData(followers,following);
      diag.unrequited=state.data.unrequited.length;
      diag.fans=state.data.fans.length;
      diag.mutual=state.data.mutual.length;
      state.diag=diag;
      console.log('[mieta] Results:', `followers=${followers.length}, following=${following.length}, unrequited=${state.data.unrequited.length}, fans=${state.data.fans.length}, mutual=${state.data.mutual.length}`);

      updateProgress(0.95,'結果を準備中…'); await sleep(300);
      updateProgress(1,'完了'); await sleep(250);
      hideAnalyzing(); showResults(); saveAnalysis();
    } catch(err){
      console.error('[mieta] Error:', err.message, 'Diag:', JSON.stringify(diag, null, 2));
      hideAnalyzing();
      const diagLines = diag.files.map(f=>`${f.name} → ${f.type} (${f.users}人)`).join('\n');
      const errLines = diag.errors.length ? '\nErrors: '+diag.errors.join(', ') : '';
      showError(err.message, `検出ファイル:\n${diagLines||'(なし)'}${errLines}\nfollowers=${diag.followersCount}, following=${diag.followingCount}`);
    }
  }

  function showError(code, diagDetail){
    const el=$('#error-msg');
    const msgs={
      INVALID_TYPE:'ファイル形式が正しくありません。Instagramから書き出された .zip または .json 形式を選択してください。',
      NO_DATA:'フォロー・フォロワーのデータが見つかりませんでした。JSON形式でダウンロードしたデータであることを確認してください。',
      SINGLE_JSON:'フォロワーとフォロー中の両方のデータが必要です。ZIP形式でダウンロードしたファイルをそのままアップロードしてください。',
    };
    const mainMsg = msgs[code]||'予期せぬエラーが発生しました。ファイルが破損していないか確認し、もう一度お試しください。';
    if(diagDetail){
      el.innerHTML=escapeHtml(mainMsg)+'<br><pre style="margin-top:8px;padding:12px;background:rgba(0,0,0,0.03);border-radius:8px;font-size:11px;line-height:1.6;white-space:pre-wrap;word-break:break-all;text-align:left;color:#666;max-height:200px;overflow-y:auto">'+escapeHtml(diagDetail)+'</pre>';
    } else {
      el.textContent=mainMsg;
    }
    el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),30000);
  }

  function showAnalyzing(){
    $('#analyzing-overlay').classList.add('show');
    $('#analyzing-bar-fill').style.width='0%';
    $('#analyzing-pct-num').textContent='0';
    $('#analyzing-status').textContent='準備中…';
  }
  function updateProgress(p,text){
    $('#analyzing-bar-fill').style.width=`${p*100}%`;
    $('#analyzing-status').textContent=text;
    animateNumber($('#analyzing-pct-num'),Math.round(p*100));
  }
  function hideAnalyzing(){ $('#analyzing-overlay').classList.remove('show'); }

  function animateNumber(el,target){
    const cur=parseInt(el.textContent)||0; if(cur===target) return;
    const step=target>cur?1:-1;
    const dur=Math.max(8,200/Math.abs(target-cur));
    let v=cur;
    const iv=setInterval(()=>{ v+=step; el.textContent=v; if(v===target) clearInterval(iv); },dur);
  }

  function animateCountUp(el,target){
    const dur=800, start=performance.now();
    const step=(now)=>{
      const p=Math.min((now-start)/dur,1);
      el.textContent=Math.round((1-Math.pow(1-p,3))*target);
      if(p<1) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
  }

  /* ═══ RESULTS ═══ */
  function showResults(){
    goToScreen('results');
    const d=state.data;
    const dg=state.diag;
    let summaryHtml=`${d.following.length}フォロー中 · ${d.followers.length}フォロワー`;
    if(dg && dg.files.length){
      summaryHtml+=`<br><small style="color:var(--sub);font-size:11px;opacity:0.6">${BUILD_VERSION} | 検出: `;
      summaryHtml+=dg.files.map(f=>`${escapeHtml(f.name)}(${f.type}:${f.users})`).join(', ');
      summaryHtml+=`</small>`;
    }
    $('#results-summary').innerHTML=summaryHtml;

    const stats=[
      {key:'unrequited',label:'フォロバなし',count:d.unrequited.length,color:'#FF3B30'},
      {key:'fans',label:'片思われ',count:d.fans.length,color:'#FF9500'},
      {key:'mutual',label:'相互',count:d.mutual.length,color:'#34C759'},
      {key:'total',label:'合計フォロー',count:d.following.length,color:'#5856D6'},
    ];
    const sg=$('#stats-grid');
    sg.innerHTML=stats.map((s,i)=>`
      <div class="stat-card" style="animation:fadeSlide 0.5s var(--ease-out) ${i*0.1}s both"
        ${s.key!=='total'?`onclick="Mieta.switchTab('${s.key}')"`:''}>
        <div class="stat-label">${escapeHtml(s.label)}</div>
        <div class="stat-value" data-target="${s.count}">0</div>
        <div class="stat-bar" style="background:${s.color}"></div>
      </div>`).join('');
    setTimeout(()=>sg.querySelectorAll('.stat-value').forEach(el=>animateCountUp(el,+el.dataset.target)),200);

    const histBtn = $('#history-btn');
    if(state.currentUser) histBtn.style.display='block';
    else histBtn.style.display='none';

    renderTabs(); renderList();
    updateShareLinks();
  }

  function renderTabs(){
    $('#result-tabs').innerHTML=CATEGORIES.map(c=>{
      const cnt=state.data[c.key].length;
      return `<button class="result-tab${state.activeTab===c.key?' active':''}" onclick="Mieta.switchTab('${c.key}')">
        ${escapeHtml(c.label)}<span class="tab-count">${cnt}</span></button>`;
    }).join('');
  }

  function switchTab(k){ state.activeTab=k; renderTabs(); renderList(); }

  function renderList(){
    const list=$('#user-list');
    const q=($('#search-input').value||'').trim().toLowerCase();
    let users=[...(state.data[state.activeTab]||[])];
    if(q) users=users.filter(u=>normalizeUsername(u.username).includes(q));
    if(state.sortMode==='name') users.sort((a,b)=>a.username.localeCompare(b.username));
    else if(state.sortMode==='newest') users.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
    else users.sort((a,b)=>(a.timestamp||0)-(b.timestamp||0));

    if(!users.length){
      list.innerHTML=`<p style="text-align:center;color:var(--sub);padding:48px 0;font-size:15px">${q?'該当するユーザーが見つかりません':'このカテゴリにユーザーはいません'}</p>`;
      $('#premium-banner').classList.remove('show'); return;
    }

    const limit = state.isPremium ? users.length : Math.min(calculateFreeLimit(), users.length);
    const locked=!state.isPremium && users.length>calculateFreeLimit();
    let html='';
    users.forEach((u,i)=>{
      const isL=i>=limit;
      const dn=isL?DUMMY_NAMES[i%DUMMY_NAMES.length]:escapeHtml(u.username);
      const dd=isL?'':formatDate(u.timestamp);
      const hr=isL?'javascript:void(0)':escapeHtml(u.href||`https://www.instagram.com/${u.username}`);
      const col=avatarColor(u.username);
      const init=(isL?'?':u.username.charAt(0)).toUpperCase();
      html+=`<div class="user-row${isL?' locked':''}" style="animation-delay:${Math.min(i*0.03,0.6)}s">
        <div class="user-info">
          <div class="user-avatar" style="background:${isL?'#D2D2D7':col}">${init}</div>
          <div class="user-name-wrap">
            <a class="user-name" href="${hr}" ${isL?'onclick="Mieta.handleProButtonClick();return false;"':'target="_blank" rel="noopener noreferrer"'}>${dn}</a>
            ${dd?`<div class="user-date">${dd}</div>`:''}
          </div>
        </div>
        ${!isL?`<div class="user-actions">
          <button class="user-action-btn" title="コピー" onclick="navigator.clipboard.writeText('${escapeHtml(u.username)}');Mieta.toast('コピーしました')">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#86868B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
          </button>
          <button class="user-action-btn" title="開く" onclick="window.open('${hr}','_blank')">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="#86868B" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          </button>
        </div>`:''}</div>`;
    });
    list.innerHTML=html;

    const banner=$('#premium-banner');
    if(locked){
      $('#premium-desc').textContent=`残り ${users.length-calculateFreeLimit()}人 のユーザーがロックされています`;
      banner.classList.add('show');
    } else banner.classList.remove('show');
  }

  function cycleSort(){
    const idx=SORT_MODES.indexOf(state.sortMode);
    state.sortMode=SORT_MODES[(idx+1)%SORT_MODES.length];
    $('#sort-btn .label').textContent=SORT_LABELS[state.sortMode];
    renderList();
  }

  function copyList(){
    if(!state.data) return;
    const users=state.data[state.activeTab]||[];
    const limit = state.isPremium ? users.length : Math.min(calculateFreeLimit(), users.length);
    navigator.clipboard.writeText(users.slice(0,limit).map(u=>u.username).join('\n'))
      .then(()=>toast(`${Math.min(limit,users.length)}件をコピーしました`));
  }

  async function shareList(){
    if(!state.data) return;
    const cat=CATEGORIES.find(c=>c.key===state.activeTab);
    const users=state.data[state.activeTab]||[];
    const limit = state.isPremium ? users.length : Math.min(calculateFreeLimit(), users.length);
    const text=users.slice(0,limit).map(u=>u.username).join('\n');
    if(navigator.share){
      try{ await navigator.share({title:`mieta — ${cat.label}`,text}); }
      catch(e){ if(e.name!=='AbortError'){ navigator.clipboard.writeText(text); toast('クリップボードにコピーしました'); }}
    } else { navigator.clipboard.writeText(text); toast('クリップボードにコピーしました'); }
  }

  function copyShareText(){
    const count = state.data ? state.data.unrequited.length : 0;
    const text = `${count}人の片思いを、整理しました。mietaで、つながりを透明に。\nhttps://ikkeitatsumi.github.io/mieta/`;
    navigator.clipboard?.writeText(text);
    $('#copy-share-label').textContent = 'Copied!';
    setTimeout(() => { $('#copy-share-label').textContent = 'コピー'; }, 2000);
  }

  function updateShareLinks(){
    const count = state.data ? state.data.unrequited.length : 0;
    const text = encodeURIComponent(`${count}人の片思いを、整理しました。mietaで、つながりを透明に。`);
    const url = encodeURIComponent('https://ikkeitatsumi.github.io/mieta/');
    const lineEl = $('#share-line');
    const xEl = $('#share-x');
    if(lineEl) lineEl.href = `https://social-plugins.line.me/lineit/share?url=${url}&text=${text}`;
    if(xEl) xEl.href = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
    $('#share-actions').style.display = 'flex';
  }

  /* ═══ AUTH & PREMIUM ═══ */

  async function handleProButtonClick(){
    if(!state.currentUser){
      showAuthModal();
    } else if(!state.isPremium){
      openUnlock();
    }
  }

  function showAuthModal(){
    $('#auth-modal').classList.add('show');
    state.authMode = 'login';
    switchAuthMode('login');
    $('#auth-email').focus();
  }

  function closeAuth(){
    $('#auth-modal').classList.remove('show');
    $('#auth-error').classList.remove('show');
    $('#auth-email').value = '';
    $('#auth-password').value = '';
  }

  function switchAuthMode(mode){
    state.authMode = mode;
    $$('.auth-toggle-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase().includes(mode==='login'?'ログイン':'サインアップ')));
    $('#auth-title').textContent = mode === 'login' ? 'ログイン' : 'サインアップ';
    $('#auth-subtitle').textContent = mode === 'login' ? 'アカウントにログインしてプレミアムを購入' : '新しいアカウントを作成する';
    $('#auth-submit').textContent = mode === 'login' ? 'ログイン' : 'アカウント作成';
  }

  async function submitAuth(){
    const email = $('#auth-email').value.trim();
    const password = $('#auth-password').value;
    const errEl = $('#auth-error');

    if(!email || !password){
      errEl.textContent = 'メールアドレスとパスワードを入力してください';
      errEl.classList.add('show');
      return;
    }

    try {
      errEl.classList.remove('show');
      const btn = $('#auth-submit');
      btn.disabled = true;

      if(state.authMode === 'login'){
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if(error) throw error;
        state.currentSession = data.session;
        state.currentUser = data.user;
      } else {
        const { data, error } = await supabase.auth.signUp({ email, password });
        if(error) throw error;
        state.currentSession = data.session;
        state.currentUser = data.user;
      }

      updateAuthUI(state.currentUser);
      closeAuth();
      toast(state.authMode === 'login' ? 'ログインしました' : 'アカウントを作成しました');

      setTimeout(() => openUnlock(), 500);
    } catch(e){
      errEl.textContent = e.message || 'エラーが発生しました';
      errEl.classList.add('show');
    } finally {
      $('#auth-submit').disabled = false;
    }
  }

  function updateAuthUI(user){
    const authDiv = $('#nav-auth');
    const proBtn = $('#nav-pro-btn');

    if(user){
      $('#nav-email').textContent = user.email || '';
      authDiv.style.display = 'flex';
      proBtn.style.display = 'none';
    } else {
      authDiv.style.display = 'none';
      proBtn.style.display = 'block';
    }
  }

  async function logout(){
    await supabase.auth.signOut();
    state.currentUser = null;
    state.currentSession = null;
    state.isPremium = false;
    localStorage.setItem(PREMIUM_KEY, 'false');
    updateAuthUI(null);
    toast('ログアウトしました');
    if(state.data) renderList();
  }

  function openUnlock(){ $('#unlock-modal').classList.add('show'); }
  function closeUnlock(){ $('#unlock-modal').classList.remove('show'); }

  async function purchasePremium(){
    if(!state.currentUser || !state.currentSession){
      showAuthModal();
      return;
    }

    try {
      const res = await fetch(SUPABASE_URL + '/functions/v1/create-checkout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + state.currentSession.access_token,
        },
        body: JSON.stringify({
          success_url: window.location.origin + window.location.pathname + '?payment=success&session_id={CHECKOUT_SESSION_ID}',
          cancel_url: window.location.origin + window.location.pathname + '?payment=cancelled',
        }),
      });

      const result = await res.json();
      if(result.url){
        window.location.href = result.url;
      } else {
        throw new Error(result.error || 'チェックアウトの作成に失敗しました');
      }
    } catch(e){
      console.error('Purchase error:', e);
      toast('エラーが発生しました: ' + e.message);
    }
  }

  async function checkPaymentReturn(){
    const params = new URLSearchParams(window.location.search);
    if(params.get('payment') === 'success' && params.get('session_id')){
      const { data: { session } } = await supabase.auth.getSession();
      if(session){
        try {
          const res = await fetch(SUPABASE_URL + '/functions/v1/verify-payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + session.access_token,
            },
            body: JSON.stringify({ session_id: params.get('session_id') }),
          });
          const result = await res.json();
          if(result.is_premium){
            state.isPremium = true;
            localStorage.setItem(PREMIUM_KEY, 'true');
            closeUnlock();
            toast('mieta+ が有効になりました！');
            if(state.data) renderList();
          }
        } catch(e){
          console.error('Verify payment error:', e);
        }
      }
      window.history.replaceState({}, '', window.location.pathname);
    }
  }

  async function checkAuthState(){
    const { data: { session } } = await supabase.auth.getSession();
    if(session){
      state.currentSession = session;
      state.currentUser = session.user;

      const { data: profile } = await supabase
        .from('profiles')
        .select('is_premium')
        .eq('id', session.user.id)
        .single();

      if(profile?.is_premium){
        state.isPremium = true;
        localStorage.setItem(PREMIUM_KEY, 'true');
      }
      updateAuthUI(session.user);
      if(state.data) renderList();
    }
  }

  function setupAuthListener(){
    supabase.auth.onAuthStateChange(async (event, session) => {
      if(session){
        state.currentSession = session;
        state.currentUser = session.user;
        const { data: profile } = await supabase
          .from('profiles')
          .select('is_premium')
          .eq('id', session.user.id)
          .single();

        if(profile?.is_premium){
          state.isPremium = true;
          localStorage.setItem(PREMIUM_KEY, 'true');
          if(state.data) renderList();
        }
        updateAuthUI(session.user);
      } else {
        state.currentSession = null;
        state.currentUser = null;
        updateAuthUI(null);
      }
    });
  }

  /* ═══ ANALYSIS HISTORY ═══ */

  async function saveAnalysis(){
    if(!state.currentSession || !state.isPremium || !state.data) return;

    try {
      await supabase.from('analysis_history').insert({
        user_id: state.currentUser.id,
        analysis_data: state.data,
        follower_count: state.data.followers.length,
        following_count: state.data.following.length,
        unrequited_count: state.data.unrequited.length,
      });
    } catch(e){
      console.error('Save analysis error:', e);
    }
  }

  function openHistory(){
    loadHistory();
    $('#history-modal').classList.add('show');
  }

  function closeHistory(){
    $('#history-modal').classList.remove('show');
  }

  async function loadHistory(){
    if(!state.currentSession){
      toast('ログインしてください');
      return;
    }

    try {
      const { data: history, error } = await supabase
        .from('analysis_history')
        .select('id, created_at, follower_count, following_count, unrequited_count')
        .eq('user_id', state.currentUser.id)
        .order('created_at', { ascending: false })
        .limit(10);

      if(error) throw error;

      const listEl = $('#history-list');
      if(!history || history.length === 0){
        listEl.innerHTML = '<div class="history-empty">過去の解析結果がありません</div>';
        return;
      }

      listEl.innerHTML = history.map(item => {
        const date = new Date(item.created_at);
        const dateStr = date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
        const timeStr = date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

        return `
          <div class="history-item" onclick="Mieta.loadHistoryItem('${item.id}')">
            <div class="history-date">${dateStr} ${timeStr}</div>
            <div class="history-stats">フォロー: ${item.following_count} • フォロワー: ${item.follower_count} • フォロバなし: ${item.unrequited_count}</div>
          </div>
        `;
      }).join('');
    } catch(e){
      console.error('Load history error:', e);
      toast('履歴の読み込みに失敗しました');
    }
  }

  async function loadHistoryItem(id){
    if(!state.currentSession) return;

    try {
      const { data: item, error } = await supabase
        .from('analysis_history')
        .select('analysis_data')
        .eq('id', id)
        .eq('user_id', state.currentUser.id)
        .single();

      if(error) throw error;

      state.data = item.analysis_data;
      state.activeTab = 'unrequited';
      closeHistory();
      showResults();
      toast('履歴を読み込みました');
    } catch(e){
      console.error('Load history item error:', e);
      toast('履歴の読み込みに失敗しました');
    }
  }

  /* ═══ RESET ═══ */
  function reset(){ backToHero(); }

  /* ═══ UPLOAD ZONE ═══ */
  function initUpload(){
    const zone=$('#upload-zone'), input=$('#file-input');
    let dc=0;
    zone.addEventListener('click',()=>input.click());
    zone.addEventListener('dragover',e=>e.preventDefault());
    zone.addEventListener('dragenter',e=>{ e.preventDefault(); dc++; zone.classList.add('dragging'); $('#bg-blobs').classList.add('active'); });
    zone.addEventListener('dragleave',()=>{ dc--; if(dc<=0){ dc=0; zone.classList.remove('dragging'); $('#bg-blobs').classList.remove('active'); }});
    zone.addEventListener('drop',e=>{
      e.preventDefault(); dc=0; zone.classList.remove('dragging'); $('#bg-blobs').classList.remove('active');
      const f=e.dataTransfer?.files?.[0]; if(f) processFile(f);
    });
    input.addEventListener('change',e=>{ const f=e.target.files[0]; if(f) processFile(f); input.value=''; });
  }

  function initScroll(){
    window.addEventListener('scroll',()=>{ $('#navbar').classList.toggle('scrolled',window.scrollY>10); },{passive:true});
  }

  function detectOS(){
    if(/android/i.test(navigator.userAgent)) switchOS('android');
    else switchOS('iphone');
  }

  function initScrollObserver(){
    const obs = new IntersectionObserver((entries) => {
      entries.forEach(e => {
        if(e.isIntersecting){
          e.target.classList.add('visible');
          obs.unobserve(e.target);
        }
      });
    }, { threshold: 0.15 });
    document.querySelectorAll('.fade-in-section').forEach(el => obs.observe(el));
  }

  /* ═══ INIT ═══ */
  function init(){
    initLens();
    initUpload();
    initScroll();
    initScrollObserver();
    detectOS();
    setupAuthListener();
    checkAuthState();
    checkPaymentReturn();

    const vEl=$('#hero-version');
    if(vEl) vEl.textContent=BUILD_VERSION;
  }

  document.addEventListener('DOMContentLoaded',init);

  /* ═══ PUBLIC API ═══ */
  return {
    goToScreen, switchOS, renderList, copyList, shareList, copyShareText, updateShareLinks,
    reset, purchasePremium, closeUnlock, openUnlock,
    switchTab, cycleSort, toast, enterApp,
    handleProButtonClick, showAuthModal, closeAuth, switchAuthMode, submitAuth, logout,
    openHistory, closeHistory, loadHistoryItem,
  };
})();
</script>
</body>
</html>
